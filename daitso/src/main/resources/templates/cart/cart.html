<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{/include/header :: header}"></head>
<body>
	<div class="cart-container">
		<div class="cart-boxes">
			<div style="display: flex; justify-content: center">
				<div style="width: 57%">
					<div class="cart-logo">
						<a th:href="@{/customer/test}"> <img class="cart-logo-img"
							th:src="@{/assets/header/daitso_logo_header.png}">
						</a>
					</div>
				</div>
			</div>
			<div style="display: flex; justify-content: center">
				<div class="cart-box">
					<div style="width: 94%;">
						<div class="cart-title">
							<div class="cart-title-img-box">
								<img class="cart-title-img" th:src="@{/assets/header/cart.svg}">
								<span style="margin-top: 20px">장바구니</span>
							</div>
							<div class="cart-order-list">
								<span>01 옵션선택</span> <img class="cart-order-list-img"
									th:src="@{/assets/common/right_arrow_gray.svg}"> <span
									style='color: #39594E; font-weight: bold;'>02 장바구니</span> <img
									class="cart-order-list-img"
									th:src="@{/assets/common/right_arrow_green.svg}"> <span>03
									주문/결제</span> <img class="cart-order-list-img"
									th:src="@{/assets/common/right_arrow_gray.svg}"> <span>04
									주문완료</span>
							</div>
						</div>
						<div class="cart-subtitle">
							<span>일반구매</span> <span>(<span th:text="${cartTotalCount}"></span>)
							</span>
						</div>
						<div class="cart-table">
							<div class="cart-table-head">
								<div class="cart-table-td-1">
									<input type="checkbox" id="check-all"> <span>전체선택</span>
								</div>
								<div class="cart-table-td-2" style="text-align: center">상품정보</div>
								<div class="cart-table-td-3" style="text-align: center">상품금액</div>
								<div class="cart-table-td-4" style="text-align: center">배송비</div>
							</div>
							<div th:if="${!cartList.isEmpty()}">
								<div class="cart-table-body" th:each="cart : ${cartList}">
									<div class="cart-table-td-1">
										<input type="checkbox" class="cart-check"
											th:value="${cart.cartId}"> <img
											th:src="${cart.productImageFirst}">
									</div>
									<div class="cart-table-td-2">
										<div style="border-bottom: 1px solid #D9D9D9;">
											<span th:text="${cart.productNm}"></span> <span
												th:if="${cart.productOptionFirst != '-'}">,</span> <span
												th:if="${cart.productOptionFirst != '-'}"
												th:text="${cart.productOptionFirst}"></span> <span
												th:if="${cart.productOptionSecond != '-'}">,</span> <span
												th:if="${cart.productOptionSecond != '-'}"
												th:text="${cart.productOptionSecond}"></span> <span
												th:if="${cart.productOptionThird != '-'}">,</span> <span
												th:if="${cart.productOptionThird != '-'}"
												th:text="${cart.productOptionThird}"></span> <span>,</span>
											<span><span th:text="${cart.cartCount}"></span>개</span>
										</div>
										<div style="display: flex; justify-content: space-between;">
											<div>
												<span style="color: #256B04"> 내일 <span
													th:text="${tomorrow.dof}"></span> <span
													th:text="${tomorrow.mad}"></span> 도착 보장
												</span> <span style="font-size: 16px; color: #777777;">(밤
													12시 전 주문시)</span>
											</div>
											<div>
												<div>
													<span><span th:text="${cart.purchaseNum}"></span>원</span> <select
														class="select-list" style="margin-left: 10px;"
														th:name="${cart.cartCount}"
														th:onchange="changeProductCount(this,[[${cart.cartId}]],[[${cart.productPrice}]])">
														<option id="one">1</option>
														<option id="two">2</option>
														<option id="three">3</option>
														<option id="four">4</option>
														<option id="five">5</option>
														<option id="siz">6</option>
														<option id="seven">7</option>
														<option id="eight">8</option>
														<option id="nine">9</option>
														<option id="ten">10</option>
													</select>
												</div>
											</div>
										</div>
									</div>
									<div class="cart-table-td-3" style="line-height: 140px">
										<span th:text="${cart.purchaseNum}" class="product-price"></span>원
									</div>
									<div class="cart-table-td-4" style="line-height: 140px">무료</div>
								</div>
							</div>
							<div th:if="${!cartList.isEmpty()}" class="cart-table-tail">
								<div style="float: right; margin-right: 20px;">
									<span class="cart-table-tail-key">상품가격</span> <span
										class="cart-table-tail-value"></span> <span
										class="cart-table-tail-key">원</span> <span
										class="cart-table-tail-plus">+</span> <span
										class="cart-table-tail-key">배송비</span> <span
										class="cart-table-tail-free">무료</span> <span
										class="cart-table-tail-plus">=</span> <span
										class="cart-table-tail-key">주문금액</span> <span
										class="cart-table-tail-value"></span> <span
										class="cart-table-tail-key">원</span>
								</div>
							</div>
						</div>
						<div th:if="${!cartList.isEmpty()}" class="cart-delete">
							<div style="cursor: pointer" onclick="chooseDelete()">선택삭제</div>
							<div style="cursor: pointer">품절/판매종료상품 전체삭제</div>
						</div>
						<div th:if="${!cartList.isEmpty()}" class="cart-discount">
							<div class="cart-discount-title">할인쿠폰 적용</div>
							<div class="cart-discount-contents">
								<div class="cart-discount-content">
									<div style="font-weight: bold;">
										<input type="checkbox"> <span
											style="margin-left: 10px;">10,000원</span>
									</div>
									<div style="margin-left: 50px">첫 구매 할인쿠폰 (6 일 8 시간 남음)</div>
								</div>
							</div>
						</div>
						<div th:if="${!cartList.isEmpty()}" class="cart-total">
							<div>
								<span class="cart-total-key">총 상품가격</span> <span
									class="cart-total-value" id="product-total-price">123,600</span>
								<span class="cart-total-key">원</span> <span
									class="cart-total-plus">-</span> <span class="cart-total-key">총
									할인</span> <span class="cart-total-sp-value">10,000</span> <span
									class="cart-total-key">원</span> <span class="cart-total-plus">+</span>
								<span class="cart-total-key">총 배송비</span> <span
									class="cart-total-value">0</span> <span class="cart-total-key">원</span>
								<span class="cart-total-plus">=</span> <span
									class="cart-total-key">총 주문가격</span> <span
									class="cart-total-sp-value">123,600</span> <span
									class="cart-total-key">원</span>
							</div>
						</div>
						<div th:if="${!cartList.isEmpty()}" class="cart-btn">
							<div class="cart-shop">
								<a th:href="@{/customer/test}"
									style="text-decoration: none; color: #39594E;">계속 쇼핑하기</a>
							</div>
							<div class="cart-purchase">
								<a th:href="@{/customer/test}"
									style="text-decoration: none; color: white;">구매하기</a>
							</div>
						</div>
						<div th:unless="${!cartList.isEmpty()}" class="cart-no-product">
								<div class="cart-no-product-text">
									장바구니에 담은 상품이 없습니다.
								</div>
						</div>
						<div th:unless="${!cartList.isEmpty()}" class="cart-no-product-info">
							<div>
								<div>각 상품에서 구매할 옵션을 선택하시고, <span style="color:#256B04; margin: 0 5px 0 5px; font-weight: 600">구매하기</span> 버튼을 눌러 보세요!</div>
								<div>선택한 옵션을 모두 장바구니에 담을 수 있습니다.</div>
								<div>	
									<div class="cart-no-product-btn"><a th:href="@{/customer/test}" style="color: white; font-size: 19px; text-decoration: none">계속 쇼핑하기</a></div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div th:replace="~{/include/footer :: footer}"></div>
		</div>
	</div>
</body>
<script type="text/javascript" th:inline="javascript">	

	// 장바구니에 담긴 물건의 총 가격 구하기
	const tableValue = document.getElementById("cart-table-tail-value");
	const productPrices = document.querySelectorAll(".product-price");
	var productTotalPrices = 0;
	
	productPrices.forEach((item) => {
		var productPrice = '';
		item.innerText.split(',').forEach((item) => {
			productPrice += item;
		})
		productTotalPrices += Number(productPrice);
	})
	
	document.querySelectorAll(".cart-table-tail-value").forEach((item) => {
		item.innerText = productTotalPrices.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
	})
	
	const productTotalPrice = document.getElementById("product-total-price");
	productTotalPrice.innerText = productTotalPrices.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
	
	// 장바구니 담긴 물건 각 개수 -> select 태그 업로드
	document.querySelectorAll(".select-list").forEach((item)=> {
		item.options[item.name - 1].selected = true;
	});
	
	function changeProductCount(target, cartId, productPrice) {
		const cartCount = target.value;
		const purchaseNum = (parseInt(productPrice.replace(/,/g , ''))) * cartCount;
		
 		fetch("http://localhost:8080/cart/update", {
		    method: "PATCH",
		    headers: { 
		        "Content-Type": "application/json",
		    },
		    body: JSON.stringify({
		        cartId: cartId,
		        cartCount: cartCount,
		        purchaseNum: purchaseNum,
		    }),
		})
		.then((res) => res.json())
		.then((data) => {
			// 새로고침
			location.reload();
		}); 
	}
	
	// 전체선택 
	const checkAll = document.getElementById("check-all");
	const checks = document.querySelectorAll(".cart-check");
	var checkNum = 0;
	
	var checkStatusList = {}
	
	checks.forEach((item) => {
		checkStatusList[item.value] = false;
	})

	
	/* '모두 동의' 체크박스가 체크가 되면 모든 체크박스의  체크를 하고, '모두 동의'
	체크박스가 해제되면 모든 체크 박스의 체크상태를 해제 */
	checkAll.addEventListener('click', (e) => {
	    const checked  = e.target.checked;
	    if (checked) {
	        checks.forEach((item) => {
	            item.checked = true; 
	            checkStatusList[item.value] = true;
	        });
	        checkNum = checks.length;
	    } else {
	        checks.forEach((item) => {
	            item.checked = false;
	            checkStatusList[item.value] = false;
	        });
	        checkNum = 0;
	    }
	});
	
	checks.forEach((item) => item.addEventListener('input', toggleCheckbox));

	function toggleCheckbox(e) {
	    const { checked , value } = e.target;
	    checkStatusList[value] = checked;
	    if(checked) {
	    	checkNum += 1;
	    } else {
	    	checkNum -= 1;
	    }
	    checkAllStatus(checkNum);
	}
	
	
	function checkAllStatus(checkNum) {
	    if(checkNum == checks.length) {
	    	checkAll.checked = true;
	    } else {
	    	checkAll.checked = false;
	    }
	}
	
	// 선택삭제
	function chooseDelete() {
		var falseStatus = 0;
		for(var key in checkStatusList) {
			if(checkStatusList[key] == true) {
				fetch("http://localhost:8080/cart/delete/" + key , {
				    method: "PATCH",
				    headers: { 
				        "Content-Type": "application/json",
				    },
				})
				.then((res) => res.json())
				.then((data) => {
					// 새로고침
					location.reload();
				}); 
			} else {
				falseStatus += 1;
			}
		}
		
		if(falseStatus == 2) {
			alert('삭제할 상품을 선택해주세요');
		}
	}
	
</script>
</html>