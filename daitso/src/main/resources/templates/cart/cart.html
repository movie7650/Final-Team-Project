<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<title>장바구니 페이지</title>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-WJB8ZT4ELE"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-WJB8ZT4ELE');
</script>
</head>
<head th:replace="include/header :: header"></head>
<body>
	<div class="cart-container">
		<div class="cart-boxes">
			<!-- <div style="display: flex; justify-content: center">
				<div style="width: 62%">
					<div class="cart-logo">
						<a th:href="@{/}"> <img class="cart-logo-img"
							th:src="@{/assets/header/daitso_logo_header.png}">
						</a>
					</div>
				</div>
			</div> -->
			<div th:replace="include/body-header :: bodyHeader"></div>
			<div style="display: flex; justify-content: center">
				<div class="cart-box">
					<div style="width: 1100px;">
						<div class="cart-title">
							<div class="cart-title-img-box">
								<img class="cart-title-img" th:src="@{/assets/header/cart.svg}">
								<span style="margin-top: 20px;">장바구니</span>
							</div>
							<div class="cart-order-list">
								<span class="korea">01 옵션선택</span> <img class="cart-order-list-img"
									th:src="@{/assets/common/right_arrow_gray.svg}"> <span
									style='color: #39594E; font-weight: bold;' class="korea">02 장바구니</span> <img
									class="cart-order-list-img"
									th:src="@{/assets/common/right_arrow_green.svg}"> <span class="korea">03
									주문/결제</span> <img class="cart-order-list-img"
									th:src="@{/assets/common/right_arrow_gray.svg}"> <span class="korea">04
									주문완료</span>
							</div>
						</div>
						<div class="cart-subtitle">
							<span class="korea">일반구매</span> <span>(<span th:text="${cartTotalCount}"></span>)
							</span>
						</div>
						<div class="cart-table">
							<div class="cart-table-head">
								<div class="cart-table-td-1">
									<input type="checkbox" id="check-all"> <span class="korea">전체선택</span>
								</div>
								<div class="cart-table-td-2 korea" style="text-align: center">상품정보</div>
								<div class="cart-table-td-3 korea" style="text-align: center">상품금액</div>
								<div class="cart-table-td-4 korea" style="text-align: center">배송비</div>
							</div>
							<div th:if="${!cartList.isEmpty()}">
								<div class="cart-table-body" th:id="'cart-table-body-' + ${cart.cartId}" th:each="cart : ${cartList}">
									<!-- 재고가 있을 경우 -->
									<div th:if="${cart.productStock > 0} and ${cart.productStatus} == 'Y'" class="cart-table-td-1">
										<input type="checkbox" 
											th:class="cart-check + ' ' + ${cart.checked}"
											th:value="${cart.cartId}"> 
										<a th:href="@{/product/{productId}/{productGroupId}(productId = ${cart.productId}, productGroupId = ${cart.productGroupId})}"><img th:src="${cart.productImageFirst}"></a>
									</div>
									<!-- 재고가 없을 경우 및 품절,판매중지 -->
									<div th:if="${cart.productStock <= 0} or ${cart.productStatus} != 'Y'" class="cart-table-td-1">
										<input type="checkbox" class="none"
											th:value="${cart.cartId}" style="visibility: hidden;"> 
										<a th:href="@{/product/{productId}/{productGroupId}(productId = ${cart.productId}, productGroupId = ${cart.productGroupId})}"><img th:src="${cart.productImageFirst}"></a>
									</div>
									<div class="cart-table-td-2">
										<div style="border-bottom: 1px solid #D9D9D9;">
											<span th:text="${cart.productNm}" class="korea"></span> <span
												th:if="${cart.productOptionFirst != '-'}">,</span> <span
												th:if="${cart.productOptionFirst != '-'}"
												th:text="${cart.productOptionFirst}"></span> <span
												th:if="${cart.productOptionSecond != '-'}">,</span> <span
												th:if="${cart.productOptionSecond != '-'}"
												th:text="${cart.productOptionSecond}"></span> <span
												th:if="${cart.productOptionThird != '-'}">,</span> <span
												th:if="${cart.productOptionThird != '-'}"
												th:text="${cart.productOptionThird}"></span>
											<span
												th:if="${cart.productStock < 10 && cart.productStock > 0}" 
												style="margin-left: 10px; font-size: 16px; font-weight:bold; color:red;">품절임박</span>
											<span
												th:if="${cart.productStock < 10 && cart.productStock > 0}" 
												style="font-size: 14px; font-weight: 600; margin-left: 3px;" class="korea">(남은 재고: <span th:text="${cart.productStock}"></span>개)</span>
											<span
												th:if="${cart.productStock <= 0}" 
												style="margin-left: 10px; font-size: 16px; font-weight:bold; color:red;" class="korea">품절</span>
												<span
												th:if="${cart.productStatus} != 'Y'" 
												style="margin-left: 10px; font-size: 16px; font-weight:bold; color:red;" class="korea">판매중지</span>
										</div>
										<div style="display: flex; justify-content: space-between;">
											<div>
												<span style="color: #256B04" class="korea"> 내일 <span
													th:text="${tomorrow.dof}"></span> <span
													th:text="${tomorrow.mad}"></span> 도착 보장
												</span> <span style="font-size: 16px; color: #777777;" class="korea">(밤
													12시 전 주문시)</span>
											</div>
											<div>
												<div>
													<span 
														th:if="${cart.productStock > 0} and ${cart.productStatus} == 'Y' and ${cart.discountRate} == 0"
														th:text="${cart.productPrice} + ' 원'"
														class="korea"
														></span>
													<span 
														th:if="${cart.productStock <= 0} or ${cart.productStatus} != 'Y'"
														class="korea">0 원</span>
													<span th:if="${cart.productStock > 0} and ${cart.productStatus} == 'Y' and ${cart.discountRate} != 0">
														<span th:text="${cart.discountRate} + '%'" style="font-size: 15px; color: red; font-weight: 500;"></span>
														<span th:text="${cart.productRealPrice} + ' 원'" style="font-size: 15px; color: #888888; text-decoration:line-through; margin: 0 10px 0 5px;" class="korea"></span>
														<span th:text="${cart.productPrice} + ' 원'" class="korea"></span>
													</span>
													<select
														th:if="${cart.productStock >= 10} and ${cart.productStatus} == 'Y'"
														class="select-list" style="margin-left: 10px; width:45px;"
														th:name="${cart.cartCount}"
														th:onchange="changeProductCount(this,[[${cart.cartId}]],[[${cart.productPrice}]],[[${customerId}]])">
														<option 
															th:each="num : ${#numbers.sequence(1,10)}"
															th:text="${num}"
															>
														</option>
													</select>
													<select
														th:if="${cart.productStock < 10 && cart.productStock > 0} and ${cart.productStatus} == 'Y'"
														class="select-list" style="margin-left: 10px; width:45px;"
														th:name="${cart.cartCount}"
														th:with="end = ${cart.productStock}"
														th:onchange="changeProductCount(this,[[${cart.cartId}]],[[${cart.productPrice}]],[[${customerId}]])">
														<option 
															th:each="num : ${#numbers.sequence(1,end)}"
															th:text="${num}"
															>
														</option>
													</select>
												</div>
											</div>
										</div>
									</div>
									<div class="cart-table-td-3 korea" style="line-height: 140px">
										<span th:if="${cart.productStock > 0} and ${cart.productStatus} == 'Y'" th:text="${cart.productTotalPrice}" th:class="'product-price-' + ${cart.cartId}"></span>
										<span th:if="${cart.productStock <= 0} or ${cart.productStatus} != 'Y'" th:class="'product-price-' + ${cart.cartId}">0</span>원
									</div>
									<div class="cart-table-td-4 korea" style="line-height: 140px">무료</div>
								</div>
							</div>
							<div th:if="${!cartList.isEmpty()}" class="cart-table-tail" id="cart-table-tail-total-price">
								<div style="float: right; margin-right: 20px;">
									<span class="cart-table-tail-key ">상품가격</span> <span
										class="cart-table-tail-value"></span> <span
										class="cart-table-tail-key ">원</span> <span
										class="cart-table-tail-plus">+</span> <span
										class="cart-table-tail-key ">배송비</span> <span
										class="cart-table-tail-free ">무료</span> <span
										class="cart-table-tail-plus">=</span> <span
										class="cart-table-tail-key ">주문금액</span> <span
										class="cart-table-tail-value"></span> <span
										class="cart-table-tail-key ">원</span>
								</div>
							</div>
						</div>
						<div th:if="${!cartList.isEmpty()}" class="cart-delete">
							<div style="cursor: pointer" th:onclick="chooseDelete([[${customerId}]])" id="choose-delete" >선택삭제</div>
							<div style="cursor: pointer" th:onclick="soldOutAndStopDelete([[${customerId}]])" >품절/판매종료상품 전체삭제</div>
						</div>
						<div th:if="${!cartList.isEmpty()}" class="cart-discount">
							<div class="cart-discount-title" style="display: flex; align-items: center; justify-content: space-between;">
								<div style="display: flex; align-items: center">
									<div >쿠폰 할인</div>
									<div class="cart-discount_btn " onclick="openDiscountPopUp()">쿠폰 조회 및 적용</div>
								</div>
								<div style="font-size: 15px; margin-right: 20px; font-weight: 500;">
									<span style="margin-right: 10px;" >총 할인금액</span>
									<span >
										<span 
											id="cart-discount-total-price"
											style="color: red; font-size: 19px; margin-right: 5px;">0</span>원
									</span>
								</div>
							</div>
						</div>
						<div th:if="${!cartList.isEmpty()}" class="cart-total">
							<div>
								<span class="cart-total-key ">총 상품가격</span> <span
									class="cart-total-value" id="product-total-price">0</span>
								<span class="cart-total-key ">원</span> <span
									class="cart-total-plus">-</span> <span class="cart-total-key ">총
									할인</span> <span class="cart-total-sp-value" id="cart-discount-total-price-2">0</span> <span
									class="cart-total-key ">원</span> <span class="cart-total-plus">+</span>
								<span class="cart-total-key ">총 배송비</span> <span
									class="cart-total-value">0</span> <span class="cart-total-key ">원</span>
								<span class="cart-total-plus">=</span> <span
									class="cart-total-key ">총 주문가격</span> <span
									class="cart-total-sp-value" id="product-total-price-final">0</span> <span
									class="cart-total-key ">원</span>
							</div>
						</div>
						<div th:if="${!cartList.isEmpty()}" class="cart-btn">
							<div class="cart-shop">
								<a th:href="@{/}"
									style="text-decoration: none; color: #39594E;" >계속 쇼핑하기</a>
							</div>
							<div class="cart-purchase">
								<div style="cursor: pointer;" onclick="goToPurchase()" >구매하기</div>
							</div>
						</div>
						<div th:unless="${!cartList.isEmpty()}" class="cart-no-product">
								<div class="cart-no-product-text ">
									장바구니에 담은 상품이 없습니다.
								</div>
						</div>
						<div th:unless="${!cartList.isEmpty()}" class="cart-no-product-info">
							<div>
								<div >각 상품에서 구매할 옵션을 선택하시고, <span style="color:#256B04; margin: 0 5px 0 5px; font-weight: 600" >구매하기</span> 버튼을 눌러 보세요!</div>
								<div >선택한 옵션을 모두 장바구니에 담을 수 있습니다.</div>
								<div>	
									<div class="cart-no-product-btn"><a th:href="@{/}" style="color: white; font-size: 19px; text-decoration: none" >계속 쇼핑하기</a></div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div th:replace="include/footer :: footer"></div>
		</div>
	</div>
</body>
<script th:src="@{/js/speech.js}"></script>
<script type="text/javascript" th:inline="javascript">	
	
    const purchaseClassification = [[${purchaseClassification}]];
    const cartList = [[${cartList}]];
	const cartDiscountTotalPrice = document.getElementById("cart-discount-total-price");
	
	function resetCartDiscountTotalPrice() {
		cartDiscountTotalPrice.innerText = '0';
		document.getElementById("cart-discount-total-price-2").innerText = '0';
		localStorage.setItem('couponTotalApplyPrice', '0');
	}
	
	const checkAll = document.getElementById("check-all");
	const checks = document.querySelectorAll(".cart-check");
	const customerId = [[${customerId}]];
	var cartTotalCount = [[${cartTotalCount}]];
	var checkNum = 0;
	var productTotalPrices = 0;
	
	var checkStatusList = {};
	var cartIdList = [];
	
	var soldOutAndStopList = [];
	
	// 총 상품가격 업데이트
	function updateTotalProductPrice(productTotalPrices) {
		document.querySelectorAll('.cart-table-tail-value').forEach((item) => {
			item.innerText = productTotalPrices.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
		})
		
		document.getElementById('product-total-price').innerText = productTotalPrices.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
		document.getElementById('product-total-price-final').innerText = productTotalPrices.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
	}
	
	// 장바구니 담긴 물건 각 개수 -> select 태그 업로드
	document.querySelectorAll(".select-list").forEach((item)=> {
		item.options[item.name - 1].selected = true;
	});
	
	// select option(상품개수) 클릭 시 가격 변경하기
	function changeProductCount(target, cartId, productPrice, customerId) {
		
		resetCartDiscountTotalPrice();
		
		const cartCount = target.value;
		const cartPrice = (parseInt(productPrice.replace(/,/g , ''))) * cartCount;
		
 		fetch( window.location.origin + "/cart/update", {
		    method: "PATCH",
		    headers: { 
		        "Content-Type": "application/json",
		        "X-CSRF-TOKEN": [[${_csrf.token}]]
		    },
		    body: JSON.stringify({
		        cartId: cartId,
		        cartCount: cartCount,
		        customerId: customerId
		    }),
		})
		.then((res) => res.json())
		.then((data) => {
			// 새로고침
			/* location.reload(); */
			document.querySelectorAll('.product-price-' + cartId).forEach((item) => {
				item.innerText = cartPrice.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
			})
			
			if(checkStatusList[cartId] == true) {
				productTotalPrices = cartPrice;
				
				Object.keys(checkStatusList).forEach((item) => {
					if(item != cartId && checkStatusList[item] == true && document.querySelector('.product-price-' + item) != null) {
						productTotalPrices += parseInt(document.querySelector('.product-price-' + item).innerText.replace(/,/g , ''));
					} 
				})
				
				updateTotalProductPrice(productTotalPrices)
			}
		}); 
	}
	
	// 체크박스 로직 및 장바구니에 담긴 물건의 총 가격 구하기
	document.querySelectorAll(".none").forEach((item) => {
		soldOutAndStopList.push(item.value);
		checkStatusList[item.value] = false;
	})

	// 체크 상태 확인해서 true면 checked를 true, false면 false로!
	const trueChecks = document.querySelectorAll(".true");
	trueChecks.forEach((item) => {
		checkStatusList[item.value] = true;
		item.checked = true;
	})
	
	const falseChecks = document.querySelectorAll(".false");
	falseChecks.forEach((item) => {
		checkStatusList[item.value] = false;
		item.checked = false;
	})
	
	// 총 상품가격 구하기
	for(var key in checkStatusList) {
		if(checkStatusList[key]){
			checkNum += 1;
			var className = '.product-price-' + key;
			var checkedProductPrice = parseInt(document.querySelector(className).innerText.replace(/,/g , ''));
			productTotalPrices += checkedProductPrice;
		} 
	}
		
	document.querySelectorAll(".cart-table-tail-value").forEach((item) => {
		item.innerText = productTotalPrices.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
	})
	
	const productTotalPrice = document.getElementById("product-total-price");
	const productTotalPriceFinal = document.getElementById("product-total-price-final");
	const productTotalPriceString = productTotalPrices.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
	productTotalPrice.innerText = productTotalPriceString;
	productTotalPriceFinal.innerText = productTotalPriceString;
	
	// 모두 체크되어있으면 전체선택 체크박스도 체크로 표시
 	if(checkNum == (Object.keys(checkStatusList).length - soldOutAndStopList.length) && checkNum !=0 && Object.keys(checkStatusList).length != 0) {
		checkAll.checked = true;
		document.getElementById("choose-delete").innerText = '전체삭제';
	} 
		
	// 각 체크박스 클릭 시 이벤트
	checks.forEach((item) => item.addEventListener('input', toggleCheckbox));

	function toggleCheckbox(e) {
		
		resetCartDiscountTotalPrice();
		
	    const { checked , value } = e.target;
	    checkStatusList[value] = checked;
	    if(checked) {
	    	checkNum += 1;
	    	cartIdList.push(value);
	    } else {
	    	checkNum -= 1;
	    	cartIdList.push(value);
	    }
	    
	    checkAllStatus(checkNum);
	    changeChecked(cartIdList,customerId,checked);
	    cartIdList = [];
	}
	
	function checkAllStatus(checkNum) {
	    if(checkNum == checks.length) {
	    	checkAll.checked = true;
	    	document.getElementById("choose-delete").innerText = '전체삭제';
	    } else {
	    	checkAll.checked = false;
	    	document.getElementById("choose-delete").innerText = '선택삭제';
	    }
	}
	
	/* '모두 동의' 체크박스가 체크가 되면 모든 체크박스의  체크를 하고, '모두 동의'
	체크박스가 해제되면 모든 체크 박스의 체크상태를 해제 */
	checkAll.addEventListener('click', (e) => {
		
		resetCartDiscountTotalPrice();
		
	    const checked  = e.target.checked;
	    if (checked) {
	        checks.forEach((item) => {
	        	if(!item.checked){
	        		item.checked = true; 
		            checkStatusList[item.value] = true;
		            cartIdList.push(item.value);
	        	}
	        });
	        checkNum = checks.length;
	        document.getElementById("choose-delete").innerText = '전체삭제';
	    } else {
	        checks.forEach((item) => {
	            item.checked = false;
	            checkStatusList[item.value] = false;
	            cartIdList.push(item.value);
	        });
	        checkNum = 0;
	        document.getElementById("choose-delete").innerText = '선택삭제';
	    }
	    
	    changeChecked(cartIdList, customerId, checked);
	    cartIdList = [];
	});
	
	// 장바구니 체크박스 상태 변경 -> 비동기 처리
	function changeChecked(cartIdList, customerId, checked){
		 fetch( window.location.origin + "/cart/update/checkbox/" + customerId, {
			    method: "PATCH",
			    headers: { 
			        "Content-Type": "application/json",
			        "X-CSRF-TOKEN": [[${_csrf.token}]]
			    },
			    body: JSON.stringify({
			        checked: checked,
			        cartIdList: cartIdList
			    }),
			})
			.then((res) => res.json())
			.then((data) => {
				// 새로고침
				/* location.reload();  */
				if(checked) {
					cartIdList.forEach((item) => {
						productTotalPrices += (parseInt(document.querySelector('.product-price-' + item).innerText.replace(/,/g , '')));
					})
				} else {
					cartIdList.forEach((item) => {
						productTotalPrices -= (parseInt(document.querySelector('.product-price-' + item).innerText.replace(/,/g , '')));
					})
				}
				
				updateTotalProductPrice(productTotalPrices);
			});  
	}
	
	// 선택삭제 및 전체삭제
	function chooseDelete(customerId) {
		
		for(var key in checkStatusList) {
 	       if (checkStatusList[key]) {
 	           cartIdList.push(key);
 	       }
 	 	}
		
		if(cartIdList.length == 0){
			alert("삭제할 상품을 선택해주세요.")
		} else {
			if (confirm("선택한 상품을 삭제하시겠습니까?")) {
				fetch( window.location.origin + "/cart/delete/" + customerId , {
				    method: "PATCH",
				    headers: { 
				        "Content-Type": "application/json",
				        "X-CSRF-TOKEN": [[${_csrf.token}]]
				    },
				    body: JSON.stringify({
				        itemList: cartIdList
				    }),
				})
				.then((res) => res.json())
				.then((data) => {
						location.reload();
				}); 	
			} else {
				cartIdList = [];
			}
		} 
	}
	
	// 품절 및 판매중지 삭제
	function soldOutAndStopDelete(customerId) {
		if(soldOutAndStopList.length == 0){
			alert("품절/판매종료상품이 없습니다.")
		} else {
			fetch( window.location.origin + "/cart/delete/" + customerId , {
			    method: "PATCH",
			    headers: { 
			        "Content-Type": "application/json",
			        "X-CSRF-TOKEN": [[${_csrf.token}]]
			    },
			    body: JSON.stringify({
			        itemList: soldOutAndStopList
			    }),
			})
			.then((res) => res.json())
			.then((data) => {
				// 새로고침
				location.reload();
			}); 	
		}	
	}
	
	// 쿠폰 조회 및 적용 선택 클릭 시
	function openDiscountPopUp() {
		
		for(var key in checkStatusList) {
 	       if (checkStatusList[key]) {
 	           cartIdList.push(key);
 	       }
	 	}
		
		if(cartIdList.length == 0) {
			alert("상품을 선택한 후 쿠폰조회 및 적용을 해주세요.");
		} else {
			if(purchaseClassification == 'cart' || purchaseClassification == null){
				window.open( window.location.origin + '/cart/coupon/' + customerId, '쿠폰 조회 및 적용', 'width=1000px,height=640px,scrollbars=yes');
				cartIdList = [];	
			} else {
				window.open( window.location.origin + '/cart/coupon/' + customerId + '/' + cartList[0].cartId, '쿠폰 조회 및 적용', 'width=1000px,height=640px,scrollbars=yes');
				cartIdList = [];
			}
		}
	}
	
	// 상품 총 할인가격
	if(localStorage.getItem('couponTotalApplyPrice') || sessionStorage.getItem('couponTotalApplyPrice')) {
		if(localStorage.getItem('couponTotalApplyPrice')) {
			var couponTotalApplyPrice = localStorage.getItem('couponTotalApplyPrice');
			
			sessionStorage.setItem('couponTotalApplyPrice', couponTotalApplyPrice);
			sessionStorage.setItem('couponApplyList', localStorage.getItem('couponApplyList'));
			sessionStorage.setItem('couponCartIdList', localStorage.getItem('couponCartIdList'));
			
			localStorage.removeItem('couponTotalApplyPrice');
			localStorage.removeItem('couponApplyList');
			localStorage.removeItem('couponCartIdList');
		} else {
			sessionStorage.removeItem('couponTotalApplyPrice');
			sessionStorage.removeItem('couponApplyList');
			sessionStorage.removeItem('couponCartIdList');
			couponTotalApplyPrice = '0';
		}
		
		cartDiscountTotalPrice.innerText = couponTotalApplyPrice;
		document.getElementById("cart-discount-total-price-2").innerText = couponTotalApplyPrice;
		document.getElementById('product-total-price-final').innerText =
		(productTotalPrices - parseInt(couponTotalApplyPrice.replace(/,/g , ''))).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");	
	}
	
	// 구매하기 버튼 클릭 시
	function goToPurchase() {
		console.log(checkStatusList)
		var falseCount = 0;
	 	for(key in checkStatusList) {
			if(checkStatusList[key] == false){
				falseCount += 1;
			}
		} 
		 if(falseCount == Object.keys(checkStatusList).length){
			alert("구매하실 상품을 선택해주세요.")
		} else {
			if(purchaseClassification == 'cart' || purchaseClassification == null) {
				window.location.href = window.location.origin + '/purchase/0';	
			} else {
				window.location.href = window.location.origin + '/purchase/' + cartList[0].cartId;
			}
		} 
	}

</script>
</html>