<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{/include/bs-header :: bsHeader}"></head>
<link rel="stylesheet" th:href="@{/css/admin-product.css}">

<body>
	<div id="productTable">
		<div th:replace="~{/include/admin-body-header :: adminBodyHeader}"></div>
		<div id="wrapper">
			<div class="topbar"
				style="position: absolute; padding-top: 115px; padding-left: 15px;">

				<!-- 왼쪽 서브 메뉴 -->
				<div class="left_sub_menu">
					<div class="sub_menu">
						<h2>TITLE</h2>
						<ul class="big_menu">
							<li>MENU 1 <i class="arrow fas fa-angle-right"></i></li>
							<ul class="small_menu">
								<li><a href="#">소메뉴1-1</a></li>
								<li><a href="#">소메뉴1-2</a></li>
								<li><a href="">소메뉴1-3</a></li>
								<li><a href="#">소메뉴1-4</a></li>
							</ul>
						</ul>
						<ul class="big_menu">
							<li>MENU 2 <i class="arrow fas fa-angle-right"></i></li>
							<ul class="small_menu">
								<li><a href="#">소메뉴2-1</a></li>
								<li><a href="#"></a>소메뉴2-2</a></li>
							</ul>
						</ul>
						<ul class="big_menu">
							<li>MYPAGE</li>
						</ul>
					</div>
				</div>
				<div class="overlay"></div>
			</div>
		</div>

		<div class="container" style="max-width: 1200px">
			<div class="row">
				<div class="col" style="z-index: 1">
					<!-- 카테고리 선택 폼 -->
					<form id="searchForm" th:action="@{/admin/product}" method="get"
						onsubmit="return searchByCategory()">
						<div class="row mt-3" style="width: 400px">
							<div class="col-sm-3" style="padding-left: 0px;">
								<label for="firstCategory"></label> <select id="firstCategory"
									onchange="getSecondCategories(this.value)"
									style="border-radius: 8px; padding-left: 5px; padding-right: 5px;">
									<option value="">전체</option>
									<option th:each="category : ${firstCategories}"
										th:value="${category.categoryId}"
										th:text="${category.categoryNm}"></option>
								</select>
							</div>

							<div class="col-sm-3">
								<label for="secondCategory"></label> <select id="secondCategory"
									onchange="updateSubcategoryProducts(this.value)"
									style="border-radius: 8px; padding-left: 5px; padding-right: 5px;">
									<option value="">전체</option>
								</select>
							</div>

							<div class="col-sm-3"
								style="padding-top: 15px; padding-left: 100px; white-space: nowrap">
								<button class="btn btn-primary"
									style="background-color: #E8C369; border-color: #E8C369"
									type="submit">조회</button>
							</div>
						</div>
					</form>
					<!-- 상품 등록 모달을 열기 위한 버튼 -->
					<button class="btn btn-primary float-right"
						style="background-color: #39594e" data-bs-toggle="modal"
						data-bs-target="#registerModal" type="button">+등록</button>
				</div>
			</div>

			<hr class="my-4">
			<div>
				<table class="table">
					<thead>
						<tr>
							<th>순번</th>
							<!-- 순번을 표시할 새로운 열 -->
							<th>그룹 ID</th>
							<th>상품명</th>
							<th>상품 코드</th>
							<th></th>
						</tr>
					</thead>
					<tbody>
						<tr th:each="product, iterStat : ${products}">
							<td th:text="${iterStat.index + 1}"></td>
							<!-- 순번을 출력 -->
							<td th:text="${product.productGroupId}"></td>
							<td th:text="${product.productNm}"></td>
							<td th:text="${product.productCode}"></td>
							<!-- <td><button name="plus" value="${product.prodcutId}" class="btn btn-xs"
								style="background-color: #668663; color: #ffff">더보기</button></td> -->
							<td>
								<div class="btn-group">
									<!-- 상품 수정 모달을 열기 위한 버튼 -->
									<button class="btn btn-xs"
										style="background-color: #39594e; color: #ffff"
										data-bs-toggle="modal" data-bs-target="#updateModal"
										type="button"
										th:onclick="setProductInfo([[${product.productId}]])">수정</button>

									<button class="btn btn-xs"
										style="background-color: red; color: #fff" type="button"
										th:onclick="deleteProduct([[${product.productId}]])">삭제</button>
								</div>
							</td>
						</tr>
					</tbody>
				</table>
			</div>

			<!-- 페이지 링크 표시 -->
			<div th:if="${totalCount > 0}">
				<ul class="pagination">
					<!-- Previous Page Link -->
					<li class="page-item"
						th:classappend="${currentPage == 1} ? disabled"><a
						class="page-link"
						th:href="@{/admin/product(page=${currentPage - 1}, pageSize=${pageSize}, firstCategoryId=${selectedFirstCategoryId}, secondCategoryId=${selectedSecondCategoryId})}"
						aria-label="Previous"> <span aria-hidden="true">&laquo;</span>
					</a></li>

					<!-- Page Links -->
					<li th:each="page : ${#numbers.sequence(1, totalPages, 1)}"
						class="page-item" th:classappend="${page == currentPage} ? active">
						<a class="page-link"
						th:href="@{/admin/product(page=${page}, pageSize=${pageSize}, firstCategoryId=${selectedFirstCategoryId}, secondCategoryId=${selectedSecondCategoryId})}"
						th:text="${page}"></a>
					</li>

					<!-- Next Page Link -->
					<li class="page-item"
						th:classappend="${currentPage * pageSize >= totalCount} ? disabled">
						<a class="page-link"
						th:href="@{/admin/product(page=${currentPage + 1}, pageSize=${pageSize}, firstCategoryId=${selectedFirstCategoryId}, secondCategoryId=${selectedSecondCategoryId})}"
						aria-label="Next"> <span aria-hidden="true">&raquo;</span>
					</a>
					</li>
				</ul>
			</div>

		</div>

		<!-- 상품 등록 모달 -->
		<div id="registerModal" class="modal fade" tabindex="-1" role="dialog">
			<div class="modal-dialog" role="document" style="max-width: 800px;">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">상품 등록</h5>
					</div>
					<form th:action method="post" enctype="multipart/form-data">
						<div class="modal-body">
							<div class="row mb-3">
								<label for="categoryId" class="col-sm-2 col-form-label">상위
									카테고리</label>
								<div class="col-sm-10">
									<select id="categoryId" name="categoryId"
										onchange="getSubCategories(this.value)" required>
										<option value="">전체</option>
										<option th:each="category : ${categories}"
											th:value="${category.categoryId}"
											th:text="${category.categoryNm}"></option>
									</select>
								</div>
							</div>

							<div class="row mb-3">
								<label form="subCategoryId" class="col-sm-2 col-form-label">하위
									카테고리</label>
								<div class="col-sm-10">
									<select id="subCategoryId" name="subCategoryId" required>
										<option value="">전체</option>
									</select>
								</div>
							</div>

							<div class="row mb-3">
								<label for="productNm" class="col-sm-2 col-form-label"
									style="color: red">* 상품명</label>
								<div class="col-sm-10">
									<input type="text" maxlength="20" id="productNm"
										name="productNm" placeholder="* 필수 입력 항목입니다." required>
								</div>
							</div>

							<div class="row mb-3">
								<label for="productContent" class="col-sm-2 col-form-label">상품
									상세내용</label>
								<div class="col-sm-10">
									<textarea id="productContent" name="productContent"
										style="height: 200px; width: 510px"></textarea>
								</div>
							</div>

							<div class="row mb-3">
								<label for="productOptionFirst" class="col-sm-2 col-form-label">사이즈</label>
								<div class="col-sm-10">
									<input type="text" id="productOptionFirst"
										name="productOptionFirst">
								</div>
							</div>

							<div class="row mb-3">
								<label for="productOptionSecond" class="col-sm-2 col-form-label">색상</label>
								<div class="col-sm-10">
									<input type="text" id="productOptionSecond"
										name="productOptionSecond">
								</div>
							</div>

							<div class="row mb-3">
								<label for="productOptionThird" class="col-sm-2 col-form-label">기타</label>
								<div class="col-sm-10">
									<input type="text" id="productOptionThird"
										name="productOptionThird">
								</div>
							</div>

							<div class="row mb-3">
								<label for="productPrice" class="col-sm-2 col-form-label"
									style="color: red">* 가격</label>
								<div class="col-sm-10">
									<input type="text" maxlength="10" id="productPrice"
										name="productPrice" onkeyup="inputNumberFormat(this);"
										style="text-align: right;" required>
								</div>
							</div>

							<div class="row mb-3">
								<label for="productStock" class="col-sm-2 col-form-label"
									style="color: red">* 수량</label>
								<div class="col-sm-10">
									<input type="text" maxlength="8" id="productStock"
										name="productStock" onkeyup="inputOnlyNumberFormat(this);"
										placeholder="* 필수 입력 항목입니다." required>
								</div>
							</div>
							<div class="row mb-3">
								<label for="productImages" class="col-sm-2 col-form-label">
									상품 이미지(3개) </label>
								<div class="col-sm-10">
									<input type="file" id="files" name="files"
										accept=".gif, .jpg, .png, .jpeg" onchange="fileCheck()"
										multiple required>
									<div id="files-error"
										style="margin: 0 0 10px 0; color: red; font-size: 16px; display: none;"></div>
								</div>
							</div>

							<div class="modal-footer">
								<!--
									<button type="button" class="btn btn-secondary"	data-dismiss="modal">닫기</button>
									<button type="submit" class="btn btn-primary">저장</button>
						-->
								<button class="btn btn-primary"
									style="background-color: #668663"
									th:onclick="|location.href='@{/admin/product)}'|" type="submit">저장</button>
								<button class="btn btn-secondary"
									th:onclick="|location.href='@{/admin/product}'|" type="button">닫기</button>
							</div>

						</div>
					</form>
				</div>
			</div>
		</div>


		<!-- 상품 수정 모달 -->
		<div id="updateModal" class="modal fade" tabindex="-1" role="dialog">
			<div class="modal-dialog" role="document" style="max-width: 800px;">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">상품 수정</h5>
					</div>
					<form th:action="@{/admin/update}" method="post">
						<input type="hidden" id="updateProductId" name="productId">
						<div class="modal-body">
							<div class="row mb-3">
								<label for="productNm" class="col-sm-2 col-form-label">상품명</label>
								<div class="col-sm-10">
									<!-- <input type="text" id="updateProductNm" name="productNm" readonly="readonly"> -->
									<span id="updateProductNm" th:text="${productNm}"
										style="font-weight: bold;"></span>
								</div>
							</div>

							<div class="row mb-3">
								<label for="productCode" class="col-sm-2 col-form-label">상품
									코드</label>
								<div class="col-sm-10">
									<!-- <input type="number" id="updateProductCode" name="productCode" readonly="readonly"> -->
									<span id="updateProductCode" th:text="${productCode}"
										style="font-weight: bold;"></span>
								</div>
							</div>
							<div class="row mb-3">
								<label for="productPrice" class="col-sm-2 col-form-label">가격</label>
								<div class="col-sm-10">
									<input type="number" id="updateProductPrice"
										name="productPrice" required>
								</div>
							</div>

							<div class="row mb-3">
								<label for="productStock" class="col-sm-2 col-form-label">수량</label>
								<div class="col-sm-10">
									<input type="number" id="updateProductStock"
										name="productStock" required>
								</div>
							</div>

							<div class="modal-footer">
								<button class="btn btn-primary"
									style="background-color: #668663" type="submit">저장</button>
								<button class="btn btn-secondary"
									th:onclick="|location.href='@{/admin/product}'|" type="button">닫기</button>
							</div>
						</div>
					</form>
				</div>
			</div>

		</div>
		<div th:replace="~{/include/footer :: footer}"></div>
	</div>
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

	<script th:inline="javascript">
    
    function getSecondCategories(firstCategoryId) {
        var secondCategory = $("#secondCategory");
        
        // 기존 옵션을 모두 지우고 기본 "전체" 옵션을 추가
        secondCategory.empty();
        secondCategory.append('<option value="">전체</option>');

        // 상위 카테고리가 "전체"로 선택된 경우, 더 이상 처리하지 않음
        if (firstCategoryId === "") {
            return;
        }
        $.ajax({
            type: "GET",
            url: "/admin/product/" + firstCategoryId,
            success: function (data) {
                // 선택된 상위 카테고리의 하위 카테고리 목록을 추가
                for (var i = 0; i < data.length; i++) {
                    secondCategory.append('<option value="' + data[i].categoryId + '">' + data[i].categoryNm + '</option>');
                }
            }
        });
    }
    
    function searchByCategory() {
        var firstCategoryId = $("#firstCategory").val();
        var secondCategoryId = $("#secondCategory").val();
        
        // 기본값 설정
        if (!firstCategoryId) {
            firstCategoryId = 0;
        }
        if (!secondCategoryId) {
            secondCategoryId = 0;
        }

        // URL 생성
        var newUrl = "/admin/product";
        if (firstCategoryId !== 0 || secondCategoryId !== 0) {
            newUrl += "?firstCategoryId=" + firstCategoryId;
            if (secondCategoryId !== 0) {
                newUrl += "&secondCategoryId=" + secondCategoryId;
            }
        }

        // 페이지 리다이렉트
        window.location.href = newUrl;
        return false; // 폼 제출 중지
    }
    
  //삭제 확인 메시지
    function deleteProduct(productId) {
        if (!confirm('정말로 삭제하시겠습니까?')) {
            return false;
        }
        const formHtml = `
            <form id="deleteForm" action="/admin/delete?productId=${productId}" method="post">
            </form>
        `;
        const doc = new DOMParser().parseFromString(formHtml, 'text/html');
        const form = doc.body.firstChild;
        document.body.append(form);
        setTimeout(() => {
            document.getElementById('deleteForm').submit();
        }, 50) //대기시간
    }
    
    //상품 수정 시 해당 상품 정보 가져오기
    function setProductInfo(productId) {
         fetch("/admin/update/" + productId)
            .then(response => response.json())
            .then(data => {
                const product = data;
                console.log(product);
                document.getElementById("updateProductId").value = product.productId; //value는 input에 사용
                document.getElementById("updateProductNm").textContent = product.productNm; //span 사용하려면 
                document.getElementById("updateProductCode").textContent = product.productCode;
                document.getElementById("updateProductPrice").value = product.productPrice;
                document.getElementById("updateProductStock").value = product.productStock;
            }); 
    }
    
    // 천 단위로 comma찍기
    function inputNumberFormat(obj) {
        obj.value = comma(uncomma(obj.value));
    }

  
    function comma(str) {
        str = String(str);
        return str.replace(/(\d)(?=(?:\d{3})+(?!\d))/g, '$1,');
    }
    function uncomma(str) {
        str = String(str);
        return str.replace(/[^\d]+/g, '');
    } 
    
    // 숫자만 입력받기
    function inputOnlyNumberFormat(obj) {
        obj.value = onlynumber(uncomma(obj.value));
    }

    function onlynumber(str) {
	    str = String(str);
	    return str.replace(/(\d)(?=(?:\d{3})+(?!\d))/g,'$1');
	}
    
    // 이미지 파일 개수 제한
    function fileCheck() {
    	var filesInput = document.getElementById("files");
        var filesError = document.getElementById("files-error");
        var filesEnrollBtn = document.getElementById("product-enroll-btn");
        
        if( filesInput.files.length < 3 ){
        	filesError.style.display = 'block';
        	filesError.innerText = '이미지 파일 3개를 업로드 해주세요';
        	filesEnrollBtn.disabled = true;
    	} else if(filesInput.files.length > 3) {
    		filesError.style.display = 'block';
        	filesError.innerText = '상품 이미지 적정 개수(3개)를 초과하였습니다!';
        	filesEnrollBtn.disabled = true;
    	} else {
    		filesError.style.display = 'none';
    		filesEnrollBtn.disabled = false;
    	}
    }

    </script>
</body>
</html>