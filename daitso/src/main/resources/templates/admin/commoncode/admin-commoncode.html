<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="include/bs-header :: bsHeader"></head>
<link rel="stylesheet" th:href="@{/css/admin-css/admin-commoncode.css}">
<link rel="stylesheet" th:href="@{/css/admin-css/admin-frame.css}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
<body>
	<div th:replace="include/admin-body-header :: adminBodyHeader"></div>
	<div th:replace="include/admin-frame :: adminFrame"></div>
	<div class="container-lg" style="padding-top: 10px">

	<div style="font-weight: bold; margin-top: 20px; font-size:20px;">공통코드 관리 <img class="cart-order-list-img" src="/assets/common/right_arrow_gray.svg"> 공통코드 조회</div>
		<div style="padding-bottom: 15px;justify-content: flex-end;border-bottom: 2px solid #1a385d;display: flex;">
			<div style="text-align: end;">
				<button class="btn btn-primary" style="background-color: #1a385d; border-color: #1a385d; font-weight: 600;"
					data-bs-toggle="modal" data-bs-target="#registerModal"
					type="button">등록</button>
			</div>
		</div>
		<div style="height: 630px;">
			<table class="table" style="text-align: center; margin-top: 20px; table-layout:fixed">
				<thead>
					<tr>
						<th style="width: 10%;">순번</th>
						<th style="width: 10%;">공통코드ID</th>
						<th style="width: 25%;">공통코드명</th>
						<th style="width: 10%;">사용여부</th>
						<th style="width: 10%;">등록자</th>
						<th style="width: 15%;">등록일</th>
						<th style="width: 14%;"></th>
					</tr>
				</thead>
				<tbody>
					<tr th:each="commonCodes : ${commonCodes}">
						<td th:text="${commonCodes.rn}"></td>
						<td th:text="${commonCodes.commonCodeId}"></td>
						<td th:text="${commonCodes.commonCodeNm}"></td>
						<td th:text="${commonCodes.status}"></td>
						<td th:text="${commonCodes.creator}"></td>
						<td th:text="${commonCodes.createDt}"></td>
						<td>
							<div class="btn-group" >
								<button class="btn btn-xs"	style="background-color: #ffffff; border: solid 2px; border-color: #1a385d;color: #1a385d;font-weight: 600;"
									data-bs-toggle="modal" data-bs-target="#searchModal"
									type="button" th:onclick="selectCommonCodesByPr([[${commonCodes.commonCodeId}]])">상세</button>
								<button class="btn btn-xs" style="background-color: #1a385d;border-color: #1a385d; font-weight: 600; color:white"
									type="button" th:onclick="deleteCommonCodePr([[${commonCodes.commonCodeId}]])">삭제</button>
							</div>
						</td>
					</tr>
				</tbody>
			</table>
		</div>
		
		<!-- 페이지 링크 표시 -->
		<div th:if="${totalCount > 0}">
			 <ul class="pagination" id="pagination">
			 <!-- 첫 페이지로 이동하는 화살표 -->
		        <li class="page-item" th:classappend="${currentPage == 1} ? disabled">
		            <a class="page-link"
		                th:href="@{/admin/common-code(page=1, pageSize=${pageSize})}"
		                aria-label="First"> <span aria-hidden="true">&laquo;</span>
		            </a>
		        </li>
				<!-- 이전 페이지 -->
				<li class="page-item" th:classappend="${currentPage == 1} ? disabled"> <!-- 현재 페이지가 1이면 비활성화 -->
					<!-- 이전 페이지로 이동하는 링크 -->
					<a class="page-link"
					th:href="@{/admin/common-code(page=${currentPage - 1}, pageSize=${pageSize})}"
					aria-label="Previous"> <span aria-hidden="true">&lsaquo;</span>
					</a>
				</li>

				<!-- 페이지 번호 링크 -->
				<li th:each="page : ${#numbers.sequence(1, totalPages, 1)}" class="page-item" th:classappend="${page == currentPage} ? active">
					<a class="page-link"
					th:href="@{/admin/common-code(page=${page}, pageSize=${pageSize})}"
					th:text="${page}">
					</a>
				</li>

				<!-- 다음 페이지 -->
				<li class="page-item" th:classappend="${currentPage * pageSize >= totalCount} ? disabled"> <!-- 현재 페이지가 마지막 페이지면 비활성화 -->
					<!-- 다음 페이지로 이동하는 링크 -->
					<a class="page-link" 
					th:href="@{/admin/common-code(page=${currentPage + 1}, pageSize=${pageSize})}"
					aria-label="Next"> <span aria-hidden="true">&rsaquo;</span>
					</a>
				</li>
				
				<!-- 마지막 페이지로 이동하는 화살표 -->
		        <li class="page-item" th:classappend="${currentPage == totalPages} ? disabled">
		            <a class="page-link"
		                th:href="@{/admin/common-code(page=${totalPages}, pageSize=${pageSize})}"
		                aria-label="Last"> <span aria-hidden="true">&raquo;</span>
		            </a>
		        </li>
			</ul>
		</div>	  
		
	<!-- 공통코드 상세 조회 모달 -->
	<div id="searchModal" class="modal fade" tabindex="-1" role="dialog">
		<div class="modal-dialog" role="document" style="max-width: 850px;">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">공통코드 상세 조회</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
					    <i class="fas fa-times"></i>
					</button>
				</div>
				<div class="modal-body">
					<table class="table" style="text-align: center;">
						<thead>
							<tr>
								<th><input type="checkbox" name='selectall' onclick='selectAll(this)'></th>
								<th>공통코드ID</th>
								<th>공통코드명</th>
								<th>사용여부</th>
								<th>등록자</th>
								<th>등록일</th>
								<th></th>
							</tr>
						</thead>
						<tbody id="commonCodeTableBody">
						</tbody>
					</table>
				</div>
				<div class="modal-footer">
					 <!-- <button class="btn btn-xs" style="background-color: #ffffff; border: solid 2px; border-color: #1a385d;color: #1a385d;font-weight: 600;" data-bs-toggle="modal" data-bs-target="#registerExistingModal"
							  type="button" onclick="registerExisting()">추가</button>  --> <!-- 잠시  -->
					<button class="btn btn-xs" style="background-color: #1a385d;border-color: #1a385d; font-weight: 600; color:white" type="button" id="deleteButton">삭제</button>
				</div>
			</div>
		</div>
	</div>

	<!-- 공통코드 수정 모달  -->
	<div id="updateModal" class="modal fade" tabindex="-1" role="dialog">
		<div class="modal-dialog" role="document" style="max-width: 600px;">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">공통코드 수정</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
					    <i class="fas fa-times"></i> <!-- "X" 아이콘 -->
					</button>
				</div>
				<form th:action="@{/admin/update-common}" method="post">
					<div class="modal-body">
						
						<div class="row mb-3" style=" display: flex; align-items: center; justify-content: space-evenly;">
							<label for="updateCommonCodeID" class="col-form-label">공통코드ID</label>
							<div class="col-sm-8">
								<input type="text" id="updateCommonCodeID" 
									name="commonCodeId" >
							</div>
						</div>
						<div class="row mb-3"  style=" display: flex; align-items: center; justify-content: space-evenly;">
							<label for="updateCommonCodeNm" class="col-form-label">공통코드명</label>
							<div class="col-sm-8">
								<input type="text" id="updateCommonCodeNm" 
									name="commonCodeNm" >
							</div>
						</div>
						<div class="row mb-3" style=" display: flex; align-items: center; justify-content: space-evenly;">
						    <label for="updateStatus" class="col-form-label" style=" margin-right: 7px;">사용여부</label>
						    <div class="col-sm-8" style="left: 5px;">
						        <select id="updateStatus" name="status">
						            <option value='Y'>Y</option>
						            <option value='N'>N</option>
						        </select>
						    </div>
						</div>

						
						<div class="modal-footer">
							<button class="btn btn-primary" style="background-color: #1a385d;border-color: #1a385d; font-weight: 600; color:white;"
								type="submit" >저장</button>
							<button type="button" class="btn btn-secondary" style="color: #fff; background-color: #c1c1c1;border-color: #c1c1c1; font-weight: 600;" data-bs-dismiss="modal">닫기</button>
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>
	
	<!-- 공통코드 '등록' 모달  -->	
	<div id="registerModal" class="modal fade" tabindex="-1" role="dialog">
		<div class="modal-dialog" role="document" style="max-width: 600px;">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">공통코드 등록</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
				    	<i class="fas fa-times"></i> <!-- "X" 아이콘 -->
					</button>
				</div>
				 <form th:action method="post">
					<div class="modal-body">
						
						<div class="row m-3" style="display: flex; align-items: center;">
							<input type="hidden" id="selectedCommonCodePr" name="commonCodePr">
							<label for="commonCodePr" class="col-sm-3"	style="padding-left: 15px;">공통코드</label>
								<div class="col-sm-3">
									<select id="commonCodePr" name="commonCodePr" style="padding-left: 5px; padding-right: 5px; border-radius:8px;" onchange="selectCommonCodePr()">
										<option value="">선택 안함</option>
										<option th:each="commonCodes : ${commonCodes}"
											th:value="${commonCodes.commonCodeId}"
											th:text="${commonCodes.commonCodeId + ' - ' + commonCodes.commonCodeNm}"></option>
									</select>
								</div>					
						</div>
						    <div class="row m-3" style="display: flex; align-items: center;">
						        <label for="commonCodeNm" class="col-sm-3">공통코드명</label>
						        <div class="col-sm-6">
						           <input type="text" id="commonCodeNm" name="commonCodeNm" required>
						        </div>
						    </div>
						
							<div class="row m-3" style="display: flex; align-items: center;">
						        <label for="commonCodeId" class="col-sm-3">공통코드ID</label>
						        <div class="col-sm-6">
						           <input type="text" id="commonCodeId" name="commonCodeId" required>
						        </div>
						    </div>
						    
						    <div class="row m-3" style="display: flex; align-items: center;">
						        <label for="sortOrder" class="col-sm-3">분류</label>
						        <div class="col-sm-6">
						           <input type="text" id="sortOrder" name="sortOrder" required>
						        </div>
						    </div>
						</div>
					<div class="modal-footer">
						<button class="btn btn-primary" style="background-color: #1a385d;border-color: #1a385d; font-weight: 600; color:white;"
							type="submit">저장</button>
						<button type="button" class="btn btn-secondary" style="color: #fff; background-color: #c1c1c1;border-color: #c1c1c1; font-weight: 600;" data-bs-dismiss="modal">닫기</button>
					</div>
				</form>
			</div>
		</div>
	</div>
	
	<!-- 공통코드 '추가' 모달 -->
	<div id="registerExistingModal" class="modal fade" tabindex="-1" role="dialog" style="overflow-y: auto;">
		<div class="modal-dialog" role="document" style="max-width: 650px;">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">공통코드 추가</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
					    <i class="fas fa-times"></i> <!-- "X" 아이콘 -->
					</button>
				</div>
				
				 <form th:action="@{/admin/common-code}" method="post">
					<div class="modal-body">
						
						<div class="row mb-3" style="display: flex; align-items: center; justify-content: center;">
							<label for="commonCodeId" class="col-sm-3 col-form-label" style="font-weight: bold;">상위 공통코드</label>
							<div class="col-sm-8">
								<input type="number" id="getCommonCodePr" name="commonCodePr" style="outline: none; width: 100%;"readonly="readonly">
							</div>
						</div>
						
						<div class="row mb-3" style="display: flex; align-items: center; justify-content: center;">
							<label for="commonCodeId" class="col-sm-3 col-form-label">공통코드ID</label>
							<div class="col-sm-8">
								<input type="text" id="commonCodeId" maxlength="10" style="width: 45%;" 
									name="commonCodeId" onkeyup="inputOnlyNumberFormat(this);" required >
							</div>
						</div>
						
						<div class="row mb-3" style="display: flex; align-items: center; justify-content: center;">
							<label for="commonCodeNm" class="col-sm-3 col-form-label">공통코드명</label>
							<div class="col-sm-8">
								<input type="text" id="commonCodeNm" maxlength="10" style="width: 45%;" 
									name="commonCodeNm" required>
							</div>
						</div>
						<div class="modal-footer">
						<div id="messageArea" th:text="${message}"></div>
							<button class="btn btn-primary" style="background-color: #1a385d;border-color: #1a385d; font-weight: 600; color:white;"
								    type="submit">저장</button>
							<button type="button" class="btn btn-secondary" style="color: #fff; background-color: #c1c1c1;border-color: #c1c1c1; font-weight: 600;" data-bs-dismiss="modal">닫기</button>
						</div>

					</div>
				</form>
			</div>
		</div>
	</div>
	
	
	</div>

	</div>
	</div>
	</div>
	<div th:replace="include/admin-footer :: footer"></div>
	<script	src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	<script th:inline="javascript">


    function registerExisting() {
       document.getElementById("getCommonCodePr").value = document.getElementById("commonCodePrs").value;
       console.log(getCommonCodePr);
   } 
	
 	function selectCommonCodePr() {
	    var selectedCommonCodePr = $("#commonCodePr").val();

	    if (selectedCommonCodePr) {
	        $("#selectedCommonCodePr").val(selectedCommonCodePr);
	    } 
	} 
 	 // 빈 문자열
    if ($("#selectedCommonCodePr").val() === "") {
        $("#selectedCommonCodePr").val(1);
    }
 	 
	// 체크 박스 선택, 해제
  	function selectAll(selectAll) {
  	    const checkboxes = document.getElementsByName('commonCodeCheckbox');
  		// 각 체크 박스의 checked 속성을 selectAll 값으로 설정해서 모두 선택하거나 해제
  	    checkboxes.forEach((checkbox) => {
  	        checkbox.checked = selectAll.checked;
  	    });
  	}
 	
 	// 모든 체크 박스가 선택되어 있는지 확인해서 selectAll 체크 박스의 상태 바꾸기
   	function checkSelectAll() {
   		 const checkboxes = document.querySelectorAll('input[name="commonCodeCheckbox"]');
   		 
  		// selectAll 체크 박스 요소 가져오기
  	    const selectAll = document.querySelector('input[name="selectall"]');
  	    //Array.from을 사용하여 checkboxes NodeList를 배열로 변환하고, every 함수를 사용해서 모든 체크 박스가 선택되어 있는지 확인
  	    selectAll.checked = Array.from(checkboxes).every((checkbox) => checkbox.checked);
  	}
 	
 	// 삭제 버튼 클릭시 이벤트 리스너 호출
   	const deleteButton = document.getElementById("deleteButton"); // deleteButton 요소 가져오기
   	if (deleteButton) {
   	    deleteButton.addEventListener("click", function () {
   	    const selectedCommonCodeIds = [];
 	    const commonCodeCheckboxes = document.querySelectorAll('input[name="commonCodeCheckbox"]');
 	    
 	    commonCodeCheckboxes.forEach((checkbox) => {
 	        if (checkbox.checked) {
 	        	selectedCommonCodeIds.push(checkbox.value);
 	        }
 	    });
 	
 	    if (selectedCommonCodeIds.length === 0) {
 	        alert("선택된 공통코드가 없습니다.");
 	        return;
 	    }
 	    
 	    if (confirm('해당 공통코드를 삭제하시겠습니까?')) {
 	        fetch("/admin/delete-common-code", {
 	            method: "POST",
 	            headers: {
 	                "Content-Type": "application/json",
 	               	"X-CSRF-TOKEN": [[${_csrf.token}]]
 	            },
 	            body: JSON.stringify(selectedCommonCodeIds),
 	        })
 	        .then((response) => response.json())
 	        .then((data) => {
 	            alert("공통코드가 삭제되었습니다.");
 	            setTimeout(() => {
 	                window.location.href = "/admin/common-code";
 	            }, 50);
 	        })
 	        .catch((error) => {
 	            console.error("공통코드 삭제 오류:", error);
 	        });
 	    }
 	}); 
   	}

	var statusValue = commonCode.status;
	var selectElement = document.getElementById("updateStatus");
	if (statusValue === 'Y') {
	    selectElement.value = 'Y';
	} else if (statusValue === 'N') {
	    selectElement.value = 'N';
	}

	
    function selectCommonCode(commonCodeId) {
         fetch("/admin/update-common/" + commonCodeId)
            .then(response => response.json())
            .then(data => {
                const commonCode = data;
                console.log(commonCode);
                document.getElementById("updateCommonCodeID").value = commonCode.commonCodeId;
                document.getElementById("updateCommonCodeNm").value = commonCode.commonCodeNm;
                document.getElementById("updateStatus").value = commonCode.status;
            }); 
    }

	 function selectCommonCodesByPr(commonCodeId) {
	 		 console.log(commonCodeId);
	         fetch("/admin/check/" + commonCodeId)
	             .then(response => response.json())
	             .then(data => {
	                 const commonCodeTableBody = document.getElementById("commonCodeTableBody");
	                 console.log(data);
	                 commonCodeTableBody.innerHTML = "";
	                 data.forEach(commonCode => {
	                     const row = document.createElement("tr");
	                     row.innerHTML = `
	                    	  <td><input type="checkbox" name="commonCodeCheckbox" onclick='checkSelectAll()' value="${commonCode.commonCodeId}"></td>
	                          <td>${commonCode.commonCodeId}</td>
	                          <td>${commonCode.commonCodeNm}</td>
	                          <td>${commonCode.status}</td>
	                          <td>${commonCode.creator}</td>
	                          <td>${commonCode.createDt}</td>
	                          <td>
			   						<button class="btn btn-xs" data-bs-toggle="modal" data-bs-target="#updateModal" 
			   							style="background-color: #1a385d;border-color: #1a385d; font-weight: 600; color:white" type="button"
			   						onclick = "selectCommonCode(${commonCode.commonCodeId})">수정</button>
			   						
			    			  </td>
			    			  <input id="commonCodePrs" type="hidden" value=${commonCode.commonCodePr}></td>
	                         `;
	                      commonCodeTableBody.appendChild(row);
	                  });
	              });
	      }
	 
	 
	 function deleteCommonCodePr(commonCodeId) {
	        if (!confirm('공통코드를 삭제하시겠습니까?')) {
	            return false;
	        }
	        const formHtml = `
	            <form id="deleteForm" action="/admin/delete-common?commonCodeId=${commonCodeId}" method="post">
	            <input type="hidden" name=` + [[${_csrf.parameterName}]] + ` value=` + [[${_csrf.token}]] + ` /> 
	            </form>
	        `;
	        const doc = new DOMParser().parseFromString(formHtml, 'text/html');
	        const form = doc.body.firstChild;
	        document.body.append(form);
	        setTimeout(() => {
	            document.getElementById('deleteForm').submit();
	        }, 50) //대기시간
	    } 
	  	
	  function uncomma(str) {
	        str = String(str);
	        return str.replace(/[^\d]+/g, '');
	    } 
	    
	    // 숫자만 입력받기
	    function inputOnlyNumberFormat(obj) {
	        obj.value = onlynumber(uncomma(obj.value));
	    }

	    function onlynumber(str) {
		    str = String(str);
		    
		    if (str.startsWith('0')) {
		        return '0';
		    }
		    return str.replace(/(\d)(?=(?:\d{3})+(?!\d))/g,'$1');
		}
	</script>

</body>
</html>