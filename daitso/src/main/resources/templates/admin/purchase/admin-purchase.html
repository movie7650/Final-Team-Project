<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{/include/bs-header :: bsHeader}"></head>
<link rel="stylesheet" th:href="@{/css/admin-product.css}">
<link rel="stylesheet" th:href="@{/css/admin-purchase.css}">
<link rel="stylesheet" th:href="@{/css/admin-frame.css}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
<body>
	<div th:replace="~{/include/admin-body-header :: adminBodyHeader}"></div>
	<div th:replace="~{/include/admin-frame :: adminFrame}"></div>

	<!-- 오른쪽 컨텐츠 -->
	<div id="table" style="padding-left:80px; padding-top: 10px;">
	<div style="font-weight: 600; margin-top: 20px; padding-left: 10px;">고객관리 > 결제 관리</div>
		<div id="searchTextDiv" style="display:flex; justify-content:flex-end; padding-right:15px; padding-bottom:15px;">
		    <select id="searchOption">
		        <option value="customerNm">회원명</option>
		        <option value="purchaseNum">주문번호</option>
		    </select>
		    <input id="searchText" style="width:15%;" type="text" onkeypress="if( event.keyCode == 13 ){searchList();}" autocomplete="off"> 
		    <input type="button" class="btn btn-secondary" style="width:7%; background-color: #39594e; border-color: #39594e; color: #ffff; margin-left: 5px;" value="검색" 
		    	   onclick="searchList()"/>
		</div>
		
		<div class="col-sm-12"	style="display: grid; grid-template-columns: repeat(3, 1fr); margin-bottom: 15px;">
				<button type="button" onclick="loadData(401)" class="btn btn-default" style="border-color: #aac8b2; border-radius:0em;">입금/결제</button>
				<button type="button" onclick="loadData(402)" class="btn btn-default" style="border-color: #aac8b2; border-radius:0em;">배송중</button>
				<button type="button" onclick="loadData(403)" class="btn btn-default" style="border-color: #aac8b2; border-radius:0em;">배송완료</button>				
		</div>


		<div style="height: 690px;">
			<table class="table" style="text-align: center;">
				<thead>
					<tr>
						<th></th>
						<th>회원명</th>
						<th>주문번호</th>
						<th>구매상품</th>
						<th>등록날짜</th>
						<th>배송상태</th>
					</tr>
				</thead>
				<tbody id="purchaseTable">		
 					 <tr th:each="purchase : ${purchaselist}">
					 	<td th:text="${purchase.rn}"></td>
						<td th:text="${purchase.customerNm}"></td>
						<td  class="test" th:text="${purchase.purchaseNum}" data-bs-toggle="modal" data-bs-target="#infoModal" style="cursor:pointer;" 
								     th:onclick="getPurchaseDetails([[${purchase.purchaseNum}]])"></td>
						<td th:text="${purchase.productNm}"></td>
						<td th:text="${purchase.createDt}"></td>
						<td>
							<form th:action="@{/admin/purchase/change-status}" method="post" style="display:flex; align-items: center; justify-content: space-evenly;">
								<input type="hidden" name="purchaseId" th:value="${purchase.purchaseId}"> 
									<select	onchange="this.form.submit()" name="commonCodeId" class="form-select">
	 								<option value="401" th:selected="${purchase.commonCodeNm == '입금/결제'}">입금/결제</option>
									<option value="402" th:selected="${purchase.commonCodeNm == '배송중'}">배송중</option>
									<option value="403" th:selected="${purchase.commonCodeNm == '배송완료'}">배송완료</option>
									</select>
							</form>
						</td>
					</tr>	 		 
			   </tbody>
			</table>
		</div>
		
		<!-- 페이지 링크 표시 -->
		<div th:if="${totalCount > 0}">
			 <ul class="pagination" id="pagination">
				<!-- 이전 페이지 -->
				<li th:classappend="${currentPage == 1} ? disabled"> <!-- 현재 페이지가 1이면 비활성화 -->
					<!-- 이전 페이지로 이동하는 링크 -->
					<a class="page-link"
					th:href="@{/admin/purchase(page=${currentPage - 1}, pageSize=${pageSize}, commonCodeId=${commonCodeId})}"
					aria-label="Previous"> <span aria-hidden="true">&laquo;</span>
					</a>
				</li>

				<!-- 페이지 번호 링크 -->
				<li th:each="page : ${#numbers.sequence(1, totalPages, 1)}" class="page-item" th:classappend="${page == currentPage} ? active">
					<a class="page-link"
					th:href="@{/admin/purchase(page=${page}, pageSize=${pageSize}, commonCodeId=${commonCodeId})}"
					th:text="${page}">
					</a>
				</li>

				<!-- 다음 페이지 -->
				<li class="page-item" th:classappend="${currentPage * pageSize >= totalCount} ? disabled"> <!-- 현재 페이지가 마지막 페이지면 비활성화 -->
					<!-- 다음 페이지로 이동하는 링크 -->
					<a class="page-link" 
					th:href="@{/admin/purchase(page=${currentPage + 1}, pageSize=${pageSize}, commonCodeId=${commonCodeId})}"
					aria-label="Next"> <span aria-hidden="true">&raquo;</span>
					</a>
				</li>
			</ul>
	  </div>
	
	<!-- 주문 내역 조회 모달 -->
	<div id="infoModal" class="modal fade" tabindex="-1"	role="dialog">
		<div class="modal-dialog" role="document" style="max-width: 800px;">
			<div class="modal-content">
				<div class="modal-header">
				<h5 class="modal-title">주문 내역 조회</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
					    <i class="fas fa-times"></i> <!-- "X" 아이콘 -->
					</button>
				</div>
						<div class="modal-body">
						<div id="purcahse">
						 <p>주문 번호 : <span id="purchaseNumSpan"></span></p>
						 <p>회원명 : <span id="customerNmSpan"></span></p>
						 </div>
							<table class="table" style="text-align:center;">
								<thead>
									<tr>
										<th style="border: outset;">상품명</th>
										<th style="border: outset;">상품가격</th>
										<th style="border: outset;">수량</th>
									</tr>
								</thead>
								<tbody id="detailTableBody">
								</tbody>
							</table>
							 <p style="text-align:right; padding-right: 20px; font-weight:inherit;">총 가격 : <span id="totalCostSpan" style="font-weight:inherit;"></span></p>
							
						</div>
						<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
						</div>
			</div>
		</div>
	</div>	
	
	</div>
</div>
</div>

	<div th:replace="~{/include/footer :: footer}"></div>
	<script	src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	<script th:inline="javascript">
	
	//배송 상태별 데이터 + 페이지
	function loadData(commonCodeId, page) {
	    $.ajax({
	        type: "GET",
	        url: "/admin/purchases",
	        data: { commonCodeId: commonCodeId, page: page }, 
	        success: function (data) {
	            var tableBody = $('#purchaseTable');
	            tableBody.empty(); 
	            
	            if (data.length === 0) {
	                var noResultRow = "<tr><td colspan='5'> 검색 결과가 없습니다.</td></tr>";
	                tableBody.append(noResultRow);
	            } else {
	            	for (var i = 0; i < data.data.length; i++) {	            		
 	                    var newRow = "<tr>" +
	                        "<td>" + data.data[i].rn + "</td>" +
	                        "<td>" + data.data[i].customerNm + "</td>" +
	                        "<td class='test' data-bs-toggle='modal' data-bs-target='#infoModal' style='cursor:pointer' onclick='getPurchaseDetails(\"" + data.data[i].purchaseNum + "\")'>" + data.data[i].purchaseNum + "</td>"+
	                        "<td>" + data.data[i].productNm + "</td>" +
	                        "<td>" + data.data[i].createDt + "</td>" +
	                        "<td>" +
	                        "<form action='/admin/purchase/change-status' method='post' style='display:flex; align-items: center; justify-content: space-evenly;'>" +
	                        "<input type='hidden' name='purchaseId' value='" + data.data[i].purchaseId + "'>" +
	                        "<select onchange='this.form.submit()' name='commonCodeId' class='form-select'>" +
	                        "<option value='401' " + (data.data[i].commonCodeId === 401 ? 'selected' : '') + ">입금/결제</option>" +
	                        "<option value='402' " + (data.data[i].commonCodeId === 402 ? 'selected' : '') + ">배송중</option>" +
	                        "<option value='403' " + (data.data[i].commonCodeId === 403 ? 'selected' : '') + ">배송완료</option>" +
	                        "</select>" +
	                        "</form>" +
	                        "</td>";
	                        "</tr>";  
	                    tableBody.append(newRow);
	                }
	            }

	            /// 페이징 정보 업데이트
	            var pagination = $('#pagination');
	            pagination.empty();

	            // 이전 페이지로 이동하는 링크
	            var prevLink = "<li class='page-item " + (data.currentPage === 1 ? 'disabled' : '') + "'>" +
	                "<a class='page-link' onclick='loadData(" + commonCodeId + ", " + (data.currentPage - 1) + ")' aria-label='Previous'><span aria-hidden='true'>&laquo;</span></a>" +
	                "</li>";
	            pagination.append(prevLink);

	            for (var i = 1; i <= data.totalPages; i++) {
	                var pageLink = "<li class='page-item " + (i === data.currentPage ? 'active' : '') + "'>" +
	                    "<a class='page-link' onclick='loadData(" + commonCodeId + ", " + i + ")'>" + i + "</a>" +
	                    "</li>";
	                pagination.append(pageLink);
	            }

	            // 다음 페이지로 이동하는 링크
	            var nextLink = "<li class='page-item " + (data.currentPage === data.totalPages ? 'disabled' : '') + "'>" +
	                "<a class='page-link' onclick='loadData(" + commonCodeId + ", " + (data.currentPage + 1) + ")' aria-label='Next'><span aria-hidden='true'>&raquo;</span></a>" +
	                "</li>";
	            pagination.append(nextLink);

	        },
	        error: function (error) {
	            console.log("에러 발생: " + error);
	        }
	    });
	}
	
	//검색한 결과 데이터 + 페이지
	function searchList(page) {
	    var searchText = $('#searchText').val();
	    var searchOption = $('#searchOption').val();
	
	    $.ajax({
	        type: "GET",
	        url: "/admin/search-purchase",
	        data: { searchText: searchText, searchOption: searchOption, page: page },
	        success: function (data) {
	            var tableBody = $('#purchaseTable');
	            tableBody.empty();
	
	            if (data.data.length === 0) {
	                var noResultRow = "<tr><td colspan='5'> 검색 결과가 없습니다.</td></tr>";
	                tableBody.append(noResultRow);
	            } else {
	                for (var i = 0; i < data.data.length; i++) {
	                	 var newRow = "<tr>" +
	                        "<td>" + data.data[i].rn + "</td>" +
	                        "<td>" + data.data[i].customerNm + "</td>" +
	                        "<td class='test' data-bs-toggle='modal' data-bs-target='#infoModal' style='cursor:pointer' onclick='getPurchaseDetails(\"" + data.data[i].purchaseNum + "\")'>" + data.data[i].purchaseNum + "</td>"+
	                        "<td>" + data.data[i].productNm + "</td>" +
	                        "<td>" + data.data[i].createDt + "</td>" +
	                        "<td>" +
	                        "<form action='/admin/purchase/change-status' method='post' style='display:flex; align-items: center; justify-content: space-evenly;'>" +
	                        "<input type='hidden' name='purchaseId' value='" + data.data[i].purchaseId + "'>" +
	                        "<select onchange='this.form.submit()' name='commonCodeId' class='form-select'>" +
	                        "<option value='401' " + (data.data[i].commonCodeId === 401 ? 'selected' : '') + ">입금/결제</option>" +
	                        "<option value='402' " + (data.data[i].commonCodeId === 402 ? 'selected' : '') + ">배송중</option>" +
	                        "<option value='403' " + (data.data[i].commonCodeId === 403 ? 'selected' : '') + ">배송완료</option>" +
	                        "</select>" +
	                        "</form>" +
	                        "</td>";
	                        "</tr>";  
	                    tableBody.append(newRow);
	                }
	            }
	
	            // 페이징 정보 업데이트
	            var pagination = $('#pagination');
	            pagination.empty();

	            // 이전 페이지로 이동하는 링크
	            var prevLink = "<li class='page-item " + (data.currentPage === 1 ? 'disabled' : '') + "'>" +
	                "<a class='page-link' onclick='searchList(" + (data.currentPage - 1) + ")' aria-label='Previous'><span aria-hidden='true'>&laquo;</span></a>" +
	                "</li>";
	            pagination.append(prevLink);

	            for (var i = 1; i <= data.totalPages; i++) {
	                var pageLink = "<li class='page-item " + (i === data.currentPage ? 'active' : '') + "'>" +
	                    "<a class='page-link' onclick='searchList(" + i + ")'>" + i + "</a>" +
	                    "</li>";
	                pagination.append(pageLink);
	            }

	            // 다음 페이지로 이동하는 링크
	            var nextLink = "<li class='page-item " + (data.currentPage === data.totalPages ? 'disabled' : '') + "'>" +
	                "<a class='page-link' onclick='searchList(" + (data.currentPage + 1) + ")' aria-label='Next'><span aria-hidden='true'>&raquo;</span></a>" +
	                "</li>";
	            pagination.append(nextLink);
	            
	        },
	        error: function (error) {
	            console.log("에러 발생: " + error);
	        }
	    });
	}
	
	
	 // 주문 상세 내역 조회하기
	 function getPurchaseDetails(purchaseNum) { 
	         fetch("/admin/purchase-details/" + purchaseNum)
	             .then(response => response.json())
	             .then(data => {            	 
	                 const detailTableBody = document.getElementById("detailTableBody");
	                 detailTableBody.innerHTML = "";
	                                
	                 const purchaseNumSpan = document.getElementById("purchaseNumSpan");
	                 purchaseNumSpan.textContent = purchaseNum;
	                 
 	                 const customerNmSpan = document.getElementById("customerNmSpan");
	                 customerNmSpan.textContent = data[0].customerNm;
                 
	                 const totalCostSpan = document.getElementById("totalCostSpan");
	                 totalCostSpan.textContent = comma(data[0].totalCost);
	                 
	                 data.forEach( purchaselist => {
	                     const row = document.createElement("tr");
	                     const purchasePrice = comma(purchaselist.purchasePrice);
	                     row.innerHTML = `
	                          <td style="border: outset;">${purchaselist.productNm}</td>
	                          <td style="text-align:right; border: outset;">${purchasePrice}</td>
	                          <td style="border: outset;">${purchaselist.purchaseCount}</td>                        
	                         `;
	                      detailTableBody.appendChild(row);
	                  });
	              });
	      }
	 
	 
	 
		// 천 단위로 comma 찍기
	    function inputNumberFormat(obj) {
	        obj.value = comma(uncomma(obj.value));
	    }

	    function comma(str) {
	        str = String(str);
	     // 0으로 시작하는 부분을 찾고, 그 뒤에 오는 0을 모두 제거한 뒤에 3자리마다 쉼표를 추가합니다.
	        return str.replace(/^0+|[^0-9]+/g, '').replace(/(\d)(?=(?:\d{3})+(?!\d))/g, '$1,');
	    }
	    
	    function uncomma(str) {
	        str = String(str);
	        return str.replace(/[^\d]+/g, '');
	    }

	</script>		
		
</body>
</html>