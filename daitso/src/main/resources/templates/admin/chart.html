<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{/include/bs-header :: bsHeader}"></head>
<link rel="stylesheet" th:href="@{/css/admin-css/admin-product.css}">
<link rel="stylesheet" th:href="@{/css/admin-css/admin-frame.css}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
	
</head>
<body>
	<div th:replace="~{/include/admin-body-header :: adminBodyHeader}"></div>
	<div th:replace="~{/include/admin-frame :: adminFrame}"></div>
	<div id="table">

		<div class="row">

			<!-- 일일, 주간, 월별 메출 통계  -->
			<div class="col-lg-6" style="margin-top: 20px;">
				<div class="card">
					<!-- 드롭다운 메뉴 -->
						<div class="filter dropdown">
						    <a class="icon dropdown-toggle" href="#" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
						        <i class="bi bi-three-dots"></i>
						    </a>
						    <ul class="dropdown-menu" aria-labelledby="filterDropdown">
						        <li class="dropdown-header">
						            <h6>Filter</h6>
						        </li>
						        <li><a class="dropdown-item" href="#" id="filterRevenueDay" data-date-type="day">일일</a></li>
						        <li><a class="dropdown-item" href="#" id="filterRevenueWeek" data-date-type="week">주간</a></li>
						        <li><a class="dropdown-item" href="#" id="filterRevenueMonth" data-date-type="month">월별</a></li>
						    </ul>
						</div>

					<div class="card-body">
						<div class="card-header">매출 현황 (주문건수, 매출액)</div>
						<canvas id="revenueChart"
							style="max-height: 400px; display: block; box-sizing: border-box; height: 210px; width: 421px;"
							width="631" height="316">
                   		 </canvas>
					</div>
				</div>
			</div>


			<!-- 일일, 주간, 월별 인기 상품 통계  -->
			<div class="col-lg-6">
				<div class="card">
				<div class="filter dropdown">
						<a class="icon dropdown-toggle" href="#" id="filterDropdown"
							data-bs-toggle="dropdown" aria-expanded="false"> <i
							class="bi bi-three-dots"></i>
						</a>
						<ul class="dropdown-menu" aria-labelledby="filterDropdown">
							<li class="dropdown-header">
								<h6>Filter</h6>
							</li>
							<li><a class="dropdown-item" href="#"
								id="filterTopSellingDay">일일</a></li>
							<li><a class="dropdown-item" href="#"
								id="filterTopSellingWeek">주간</a></li>
							<li><a class="dropdown-item" href="#"
								id="filterTopSellingMonth">월별</a></li>
						</ul>
					</div>
					
					<div class="card-body">
						<div class="card-header">가장 많이 팔린 상품</div>
						<canvas id="topSellingChart"
							style="max-height: 250px; display: block; box-sizing: border-box; height: 210px; width: 300px;"
							width="300" height="210">
						</canvas>
					</div>
				</div>
			</div>


			<div class="col-lg-6" style="margin-top: 20px;">
				<div class="card">
					<div class="card-body">
						<div class="card-header">재고 현황</div>
							<canvas id="stockChart" style="max-height: 250px; display: block; box-sizing: border-box; height: 250px; width: 300px;"
							width="300" height="210">
						</canvas>
					</div>
				</div>
			</div>
			
			<div class="col-lg-6">
				<div class="card">
					<div class="card-body">
						<div class="card-header">월별 회원 유입</div>
							<canvas id="myChart" style="max-height: 250px; display: block; box-sizing: border-box; height: 250px; width: 300px;"
							width="300" height="210">
						</canvas>
					</div>
				</div>
			</div>

	</div>
			<!--  -->
	</div>
	</div>
	</div>

	<div th:replace="~{/include/footer :: footer}"></div>
	<!-- Chart.js 라이브러리 추가 -->
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script	src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

	<script th:inline="javascript">
	
	
	$.ajax({
	    url: "/admin/bar", // 서버 엔드포인트
	    method: "GET",
	    dataType: "json", // JSON 데이터 형식
	    success: function (data) {
			console.log(data);

	        var labels = []; // 월별 레이블
	        var signUpCounts = []; // 월별 회원 가입 수 데이터

	        for (var i = 0; i < data.length; i++) {
	            labels.push(data[i].registerMonth);
	            signUpCounts.push(data[i].count);
	        }

	        var monthlySignUpData = {
	            labels: labels,
	            datasets: [{
	                label: "월별 회원 가입 수",
	                data: signUpCounts,
	                backgroundColor: 'rgba(75, 192, 192, 0.2)',
	                borderColor: 'rgba(75, 192, 192, 1)',
	                borderWidth: 1
	            }]
	        };

	        var ctx = document.getElementById('myChart').getContext('2d');
	        var myChart = new Chart(ctx, {
	            type: 'bar',
	            data: monthlySignUpData,
	            options: {
	                scales: {
	                    y: {
	                        beginAtZero: true
	                    }
	                }
	            }
	        });
	    },
	    error: function (error) {
	        console.log("에러 발생: " + error);
	    }
	});


	
    function fetchDataAndRenderChart() {
        // Ajax 요청 보내기
        $.ajax({
            url: '/admin/pies', // 컨트롤러 엔드포인트 URL
            method: 'GET',
            success: function (data) {
            	console.log(data);
            	
                var labels = data.map(item => item.productNm || item.label);
                var quantities = data.map(item => item.productStock);
				
                var backgroundColors = data.map(item => {
                    return item.label === 'Stock Sufficient' ? '#3333FF' : '#FF5733';
                });

                
                console.log(labels);
                console.log(quantities);
                // 파이 차트 생성
                var ctx = document.getElementById('stockChart').getContext('2d');
                var stockChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: quantities,
                            backgroundColor: backgroundColors,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                    }
                });
            },
            error: function (error) {
                console.error('Error fetching data:', error);
            }
        });
    }

    // 페이지 로드 시 데이터 가져와서 차트 생성
    fetchDataAndRenderChart();
     
     
	document.addEventListener("DOMContentLoaded", () => {
	    var revenueCtx = document.getElementById('revenueChart').getContext('2d');
	    var revenueChart; // 차트 객체를 전역 변수로 선언

	    // 드롭다운 메뉴 클릭 이벤트 핸들러
	    document.getElementById('filterRevenueDay').addEventListener('click', function () {
	        loadDataAndRefreshChart('day');
	    });

	    document.getElementById('filterRevenueWeek').addEventListener('click', function () {
	        loadDataAndRefreshChart('week');
	    });

	    document.getElementById('filterRevenueMonth').addEventListener('click', function () {
	        loadDataAndRefreshChart('month');
	    });

	    // 데이터를 불러와서 차트를 업데이트하는 함수
	    function loadDataAndRefreshChart(dateType) {
	        // AJAX 요청을 보냅니다.
	        $.ajax({
	            url: '/admin/charts?dateType=' + dateType, // 선택한 dateType을 서버에 전달
	            method: 'GET',
	            dataType: 'json',
	            success: function (data) {
	            	console.log(data);
	                // 데이터를 가져오면 차트를 업데이트합니다.
	                if (revenueChart) {
	                    revenueChart.destroy(); // 기존 차트 제거
	                }

	                revenueChart = new Chart(revenueCtx, {
	                    type: 'line',
	                    data: {
	                        labels: data.dates,
	                        datasets: [{
	                            label: '주문건수',
	                            data: data.orderCounts,
	                            fill: false,
	                            borderColor: 'rgb(75, 192, 192)',
	                            tension: 0.1
	                        }, {
	                            label: '매출액',
	                            data: data.revenueData,
	                            fill: false,
	                            borderColor: 'rgb(255, 99, 132)',
	                            tension: 0.1
	                        }]
	                    },
	                    options: {
	                        scales: {
	                            y: {
	                                beginAtZero: true,
	                                ticks: {
	                                    callback: function (value, index, values) {
	                                        if (value >= 1000000) {
	                                            return (value / 1000000).toFixed(1) + 'M';
	                                        } else if (value >= 1000) {
	                                            return (value / 1000).toFixed(1) + 'K';
	                                        } else {
	                                            return value;
	                                        }
	                                    }
	                                }
	                            }
	                        }
	                    }
	                });
	            },
	            error: function (error) {
	                console.error('Error fetching data:', error);
	            }
	        });
	    }

	    // 페이지 로드시 초기 데이터를 불러와서 차트를 생성
	    loadDataAndRefreshChart('week');
	});
	
	

	document.addEventListener("DOMContentLoaded", () => {
	    var topSellingCtx = document.getElementById('topSellingChart').getContext('2d');
	    var topSellingChart; // 차트 객체를 전역 변수로 선언

	    // 드롭다운 메뉴 클릭 이벤트 핸들러
	    document.getElementById('filterTopSellingDay').addEventListener('click', function () {
	        fetchAndRenderTopSellingChart('day');
	    });

	    document.getElementById('filterTopSellingWeek').addEventListener('click', function () {
	        fetchAndRenderTopSellingChart('week');
	    });

	    document.getElementById('filterTopSellingMonth').addEventListener('click', function () {
	        fetchAndRenderTopSellingChart('month');
	    });

	    function fetchAndRenderTopSellingChart(dateType) {
	        // 이전 차트 파괴
	        if (topSellingChart) {
	            topSellingChart.destroy();
	        }

	        // AJAX를 통해 새로운 데이터를 가져옵니다.
	        $.ajax({
	            url: '/admin/pie?dateType=' + dateType, // Pie 차트를 위한 URL로 변경
	            method: 'GET',
	            success: function (data) {
	                console.log(data);
	                var productNames = data.productNames;
	                var salesData = data.salesData;

	                // Pie 차트 데이터 생성
	                var pieData = {
	                    labels: productNames,
	                    datasets: [{
	                        data: salesData,
	                        backgroundColor: getRandomColors(salesData.length), // 랜덤 색상 생성
	                    }]
	                };

	                // Pie 차트 생성
	                topSellingChart = new Chart(topSellingCtx, {
	                    type: 'pie',
	                    data: pieData,
	                    options: {
	                        responsive: true,
	                        maintainAspectRatio: false
	                    }
	                });
	                
	            },
	            error: function (error) {
	                console.error('Error fetching data:', error);
	            }
	        });
	    }

	    // 랜덤 색상을 생성하는 함수 (Pie 차트에서 사용)
	    function getRandomColors(count) {
	        var colors = [];
	        for (var i = 0; i < count; i++) {
	            var color = '#' + Math.floor(Math.random()*16777215).toString(16); // 랜덤 HEX 색상 생성
	            colors.push(color);
	        }
	        return colors;
	    }

	    // 페이지 로드시 초기 데이터를 불러와서 차트를 생성
	    fetchAndRenderTopSellingChart('week');
	});





</script>

</body>
</html>
