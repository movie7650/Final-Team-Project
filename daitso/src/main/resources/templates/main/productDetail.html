<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<title>카테고리별 상품 리스트</title>
</head>
<div th:replace="~{/include/header :: header}"></div>
<body>
<div th:replace="~{/include/body-header :: bodyHeader}"></div>
<div class="d-flex justify-content-center align-items-center" style="height: 530px">
	<div class="d-flex" style="width: 1100px; height:440px">
		<div style="width: 473px; height: 440px;">
			<img style="width: 100%; height: 100%" th:src="@{/images/mainImages.png}">
		</div>
		<div style="margin-left: 77px; width: 500px; height:440px">
			<h3>[[${product.productNm}]]</h3>
			<input class="hidden-product-id" type="hidden">
			<div style="height:24px">
				<div class="star-parent">
					<div class="star-fill" th:style="'width: ' + ${reviewAvg} + '%;'">
						<span>★</span><span>★</span><span>★</span><span>★</span><span>★</span>
					</div>
					<div class="star-base">
						<span>★</span><span>★</span><span>★</span><span>★</span><span>★</span><span>([[${rCnt}]])</span>
					</div>
				</div>
			</div>
			<hr></hr>
			<h5 class="total-price" style="color: red"></h5>
			<p class="font-s-13">무료 배송(산간 지역은 별도)<p>
			<div class="d-flex">
				<span class="align-self-center">옵션</span>
				<div class="d-flex option-list" style="margin-left:10px">
					<select class="option-size" name="size" th:if='!${oListFirst[0].OPTIONFIRST.equals("0")}' th:onchange="optionChange([[${product.productGroupId}]],1)">
						<th:block th:each="option : ${oListFirst}">
							<option th:selected="${option.OPTIONFIRST eq product.productOptionFirst}">[[${option.OPTIONFIRST}]]</option>
						</th:block>
					</select>
					<div class="option-list-color">
						<select class="option-color" name="color" th:if='!${oListSecond[0].OPTIONSECOND.equals("0")}' th:onchange="optionChange([[${product.productGroupId}]],2)">
							<th:block  th:each="option : ${oListSecond}">
								<option th:selected="${option.OPTIONSECOND eq product.productOptionSecond}">[[${option.OPTIONSECOND}]]</option>
							</th:block>
						</select>
					</div>
					<div class="option-list-other">
						<select class="option-other" name="others" th:if='!${oListThird[0].OPTIONTHIRD.equals("0")}' th:onchange="optionChange([[${product.productGroupId}]],3)">
							<th:block th:each="option : ${oListThird}">
								<option>[[${option.OPTIONTHIRD}]]</option>
							</th:block>
						</select>
					</div>
				</div>
			</div>
			<div class="d-flex" style="margin-bottom:20px">
				<span class="align-self-center">수량</span>
				<input class="cnt-input" style="margin-left: 10px; border: 1px solid; border-right:none;" type="text" value=1 readonly>
				<div class="d-flex flex-column" style="border: 1px solid; border-left: none;">
					<button class="cnt-btn" onclick="cntBtn('plus')"><img th:src="@{/assets/common/angle-up-solid.svg}"></button>
					<button class="cnt-btn" onclick="cntBtn('minus')"><img th:src="@{/assets/common/angle-down-solid.svg}"></button>
				</div>
			</div>
			<div class="d-flex" style="height:40px">
				<div class="add-cart-btn d-flex justify-content-center align-items-center width-50-per" onclick="goToCart()">
					<span>장바구니 담기</span>
				</div>
				<div class="direct-purchase-btn d-flex justify-content-center align-items-center width-50-per" >
					<span>구매하기</span>
				</div>
			</div>
		</div>
	</div>
</div>
<div class="review-frame d-flex flex-column justify-content-center align-items-center">
	<div style="width:1100px">
		<h4 style="margin-bottom:30px;">상품리뷰([[${rCnt}]])</h4>
		<div class="review-body" style="min-height: 600px;">
		<th:block th:each="review : ${rList}">
			<div>
				<div>
					<p class="margin-b-0">[[${review.customerNm}]]</p>
					<div style="height:24px">
						<div class="star-parent">
							<div class="star-fill" th:style="'width: ' + ${review.reviewStarPoint} + '%;'">
								<span>★</span><span>★</span><span>★</span><span>★</span><span>★</span>
							</div>
							<div class="star-base">
								<span>★</span><span>★</span><span>★</span><span>★</span><span>★</span><span style="font-size:10px">[[${review.createDt}]]</span>
							</div>
						</div>
					</div>
					<p style="color:gray">[[${review.productNm}]] [[${review.options}]]</p>
				</div>
				<div class="d-flex" style="height:100px; margin-bottom:10px">
					<!-- 나중에 th:each로 이미지 가져오자. 지금은 없으니 sample image로 대체 -->
					<img style="width: 100px; height: 100%" th:src="@{/images/mainImages.png}">
				</div>
				<p style="font-weight: bold; margin-bottom:0px;">[[${review.reviewTitle}]]</p>
				<p>[[${review.reviewContent}]]</p>
				<hr></hr>
			</div>
		</th:block>
		</div>
		<div class="d-block">
			<div class="d-flex justify-content-center mb-4">
				<div th:replace="~{/include/product-review-paging :: product-review-paging}"></div>			
			</div>
		</div>
		<div class="d-flex justify-content-between">
			<h4 style="align-self:center">상품 문의</h4>
			<button class="inquiry-btn" onclick="openModal()">문의하기</button>
		</div>
		<div>
			<p class="margin-b-0">● 구매한 상품의 <span style="font-weight:bold">취소/반품은 마이쿠팡 구매내역에서 신청</span> 가능합니다.</p>
			<p class="margin-b-0">● 상품문의 및 리뷰를 통해 취소나 환불, 반품 등은 처리되지 않습니다.</p>
			<p class="margin-b-0">● <span style="font-weight:bold">가격,판매자,교환/환불 및 배송 등 해당 상품 자체와 관련 없는 문의는 고객센터 내 1:1 문의하기</span>를 이용해주세요.</p>
			<p class="margin-b-0">● <span style="font-weight:bold">"해당 상품 자체"와 관계없는 글, 양도, 광고성, 욕설, 비방, 도배 등의 글은 예고 없이 이동, 노출제한, 삭제 등의 조치가 취해질 수 있습니다.</span>
			<p class="margin-b-0">● 공개 게시판이므로 전화번호, 메일 주소 등 고객님의 소중한 개인정보는 절대 남기지 말아주세요.
		</div>
	</div>
</div>
<div class="modal">
	<div class="modal-frame">
		<div style="background-color:#e5e5e5">
			<div class="d-flex justify-content-between align-items-center" style="margin: 0 10px 0 10px; height: 55px">
				<h5 style="margin:0px">상품 문의</h5>
				<div onclick="closeModal()"><span style="font-size:30px; cursor:pointer">×</span></div>
			</div>
		</div>
		<hr style="border: 1px solid; margin: 40px 10px 0 10px;"></hr>
		<div style="margin: 0 10px 0 10px">
			<form class="inquiry-form" action="/inquiry/insert" method="post">
			    <div class="d-flex" style="height:120px; border-bottom: 1px solid;">
			    	<div class="d-flex justify-content-center align-items-center" style="flex:1; border-right: 1px solid;">
			    		<p>상품옵션</p>
			    	</div>
			    	<div class="d-flex flex-column justify-content-center align-items-center" style="flex:6;">
			    		
			    			<input type="hidden" name="productGroupId" th:value="${product.productGroupId}">
				    		<div class="d-flex flex-column" style="width:450px;">
					    		<select class="inquiry-product-size margin-b-10" name="size" style="width: 200px" th:onchange="inquiryOptionChange([[${product.productGroupId}]],1)">
					    			<th:block th:each="option : ${oListFirst}">			    	
					    				<option th:if="${option.OPTIONFIRST == '0'}">사이즈옵션 없음</option>
										<option th:selected="${option.OPTIONFIRST eq product.productOptionFirst}" th:if="${option.OPTIONFIRST != '0'}">[[${option.OPTIONFIRST}]]</option>
									</th:block>
					    		</select>
					    		<select class="inquiry-product-color margin-b-10" name="color" style="width: 200px" th:onchange="inquiryOptionChange([[${product.productGroupId}]],2)">
					    			<th:block  th:each="option : ${oListSecond}">
					    				<option th:if="${option.OPTIONSECOND == '0'}">색상옵션 없음</option>
										<option th:selected="${option.OPTIONSECOND eq product.productOptionSecond}" th:if="${option.OPTIONSECOND != '0'}">[[${option.OPTIONSECOND}]]</option>
									</th:block>
					    		</select>
					    		<select class="inquiry-product-other margin-b-10" name="other" style="width: 200px">
					    			<th:block th:each="option : ${oListThird}">
					    				<option th:if="${option.OPTIONTHIRD == '0'}">기타옵션 없음</option>
										<option th:if="${option.OPTIONTHIRD != '0'}">[[${option.OPTIONTHIRD}]]</option>
									</th:block>
					    		</select>
				    		</div>	
			    	</div>
			    </div>
			    <div class="d-flex" style="height:300px; border-bottom: 1px solid;">
			    	<div class="d-flex justify-content-center align-items-center" style="flex:1; border-right: 1px solid;">
			    		<p>문의내용</p>
			    	</div>
			    	<div class="d-flex justify-content-center align-items-center" style="flex:6;">
			    		<input type="text" name="content" style="height:90%; width:450px"> 
			    	</div>
			    </div>
		    </form>
		</div>
		<p style="font-size:13px">* 개인정보(주민번호, 연락처, 주소, 계좌번호, 카드번호 등)가 포함되지 않도록 유의해주세요.</p>
		<div class="d-flex justify-content-center">
			<div style="width:100px; height:30px; background-color:blue; color:white; margin-right: 5px; cursor: pointer" onclick="insertInquiry()">확인</div>
			<div style="width:100px; height:30px; border:1px solid; cursor: pointer" onclick="closeModal()">취소</div>
		</div>
	</div>
</div>
<div th:replace="~{/include/footer :: footer}"></div>
</body>
<script th:inline="javascript">
	const body = document.querySelector("body");
	const modal = document.querySelector(".modal");
	const cntInput = document.querySelector(".cnt-input");
	const hiddenProductId = document.querySelector('.hidden-product-id');
	const totalPrice = document.querySelector(".total-price");
	let fPrice = 0;
	product = /*[[${product}]]*/
	hiddenProductId.value = product.productId;
	fPrice = product.productPrice;
	totalPrice.textContent = fPrice.toString().replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",") + '원';
	totalPrice.value = fPrice;



	function cntBtn(division){
		if(division == 'plus'){
			var num = cntInput.value;
			if(num == product.productStock){
				window.alert("max holloway");
			}else{

				var tPrice = (Number(num) + 1) * fPrice
				totalPrice.textContent = tPrice.toString().replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",") + '원';
				totalPrice.value = tPrice;
				cntInput.value = Number(num) + 1;
			}
		}
		else if(division == 'minus'){
			var num = cntInput.value;
			if(num == 1){
				window.alert('1미만은 안됨')
			}else{
				var tPrice = (Number(num) - 1) * fPrice;
				totalPrice.textContent = tPrice.toString().replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",") + '원';
				totalPrice.value = tPrice;
				cntInput.value = Number(num) - 1;
			}
		}
	}
	
	function inquiryOptionChange(productGroupId, num){
		const optionSize = document.querySelector(".inquiry-product-size");
		const optionColor = document.querySelector(".inquiry-product-color");
		const optionOther = document.querySelector(".inquiry-product-other");
		console.log(optionSize.value, optionColor, optionOther);
		var param = `?productGroupId=${productGroupId}`;
		if(num == 1){
			param += `&optionFirst=${optionSize.value}`;
		}
		else if(num == 2){
			param += `&optionFirst=${optionSize.value}&optionSecond=${optionColor.value}`;
		}
		fetch("/product/inquiry/option" + param)
		.then(response => response.json())
		.then(data => {
			if(data.length == 1){
	        	if(data[0].length != 1 | data[0][0].OPTIONTHIRD != 0){
	        		optionOther.innerHTML = "";
	        		data[0].forEach(option => {
	        			if(option.OPTIONTHIRD != 0){
		        			const selectOption = `<option>${option.OPTIONTHIRD}</option>`
		        			optionOther.innerHTML += selectOption;    				
	        			}
	        			
	        		})
	        	}else{
	        		optionOther.innerHTML = "";
	        	}
			}
			else{
				if(data[0].length != 1 | data[0][0].OPTIONSECOND != 0){
	        		optionColor.innerHTML = "";
	        		data[0].forEach(option => {
	        			if(option.OPTHIONSECOND != 0){
	    	    			const selectOption = `<option>${option.OPTIONSECOND}</option>`
	   		     			optionColor.innerHTML += selectOption;	        				
	        			}
	        			
	                })
	        	}else{
	        		optionColor.innerHTML = "";
	        	}
	        	if(data[1].length != 1 | data[1][0].OPTIONTHIRD != 0){
	        		optionOther.innerHTML = "";
	        		data[1].forEach(option => {
	        			if(option.OPTIONTHIRD != 0){
	        				const selectOption = `<option>${option.OPTIONTHIRD}</option>`
	    	        		optionOther.innerHTML += selectOption;
	        			}
	        		})
	        	}else{
	        		optionOther.innerHTML = "";
	        	}
			}
		})
	}

	function optionChange(productGroupId, num){
		const optionList = document.querySelector(".option-list");
		var optionSize = document.querySelector(".option-size");
		var optionColor = document.querySelector(".option-color");
		var optionOther = document.querySelector(".option-other");
		var sColor = document.querySelector(".option-list-color");
		var sOther = document.querySelector(".option-list-other");
		var cColor = "";
		var cOther = "";
		if(optionSize == null){
			optionSize = "0";
		}
		else{optionSize = optionSize.value}
		if(optionColor == null){
			optionColor = "0";
		}
		else{optionColor = optionColor.value}
		if(optionOther == null){
			optionOther = "0";
		}
		else{optionOther = optionOther.value}
		var params = `?`;
		if(num == 1){
			params += `optionFirst=${optionSize}`;
		}
		else if(num == 2){
			params += `optionFirst=${optionSize}&optionSecond=${optionColor}`;
		}
		else if(num == 3){
			params += `optionFirst=${optionSize}&optionSecond=${optionColor}&optionThird=${optionOther}`;
		}

        fetch("/product/change/" + productGroupId + params)
        .then(response => response.json())
        .then(data => {
            const product = data;
            const cPrice = product.productPrice;
            totalPrice.textContent = cPrice.toString().replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",") + '원';
        	totalPrice.value = cPrice;
        	fPrice = cPrice;
        	hiddenProductId.value = product.productId;
        	cColor = product.productOptionSecond;
        	cOther = product.productOptionThird;
        	cntInput.value = 1;
        	if(num == 1){
        		params += `&optionSecond=${cColor}`;
        	} 
        	fetch("/product/option/" + productGroupId + params)
            .then(response => response.json())
            .then(data => {
                	if(data[0].length != 1 | data[0][0].OPTIONSECOND != 0){
                		const select = `<select class="option-color" name="color" onchange="optionChange('${product.productGroupId}',2)"></select>`
                		sColor.innerHTML = select;
                		const s = document.querySelector(".option-color");
                		data[0].forEach(option => {
                			const selectOption = `<option>${option.OPTIONSECOND}</option>`
        	        		s.innerHTML += selectOption;
                        })
                        const len = s.options.length;
                        for(let i=0; i<len; i++){
                        	//console.log(s.options[i].value, " + " , optionColor.value);
                        	if(s.options[i].value == cColor){
                        		s.options[i].selected = true;
                        	}
                        }
                	}
                	if(data[1].length != 1 | data[1][0].OPTIONTHIRD != 0){
                		const select = `<select class="option-other" name="other" onchange="optionChange('${product.productGroupId}',3)"></select>`
                		sOther.innerHTML = select;
                		const s = document.querySelector(".option-other");
                		data[1].forEach(option => {
                			const selectOption = `<option>${option.OPTIONTHIRD}</option>`
                			s.innerHTML += selectOption;
                		})
                		const len = s.options.length;
                		//console.log(s);
                		//console.log("cold", cOther);
                		for(let i=0; i<len; i++){
                			if(s.options[i].value == cOther){
                				s.options[i].selected = true;
                			}
                		}
                	}
                	else{
                		sOther.innerHTML = "";
                	}
            });   
        });
	}
	
	function goToCart(){
		let tag = document.createElement('form');
		
		let objId = document.createElement('input');
		objId.setAttribute('type', 'hidden');
		objId.setAttribute('name', 'productId');
		objId.setAttribute('value', hiddenProductId.value);
		
		let objCnt = document.createElement('input');
		objCnt.setAttribute('type', 'hidden');
		objCnt.setAttribute('name', 'productCnt');
		objCnt.setAttribute('value', cntInput.value);
		
		tag.appendChild(objId);
		tag.appendChild(objCnt);
		tag.setAttribute('method', 'post');
		tag.setAttribute('action', '/cart/insert');
		document.body.appendChild(tag);
		tag.submit();
	}

	function changeReviewPage(productGroupId, page){
		const reviewBody = document.querySelector(".review-body");
		reviewBody.innerHTML = "";
		fetch("/review/" + productGroupId +"/" + page)
		.then(response => response.json())
		.then(data => {
			data.forEach(review => {
				const rElement = `
					<div>
					<p style="margin-bottom:0px">${review.customerNm}</p>
					<div style="height:24px">
						<div class="star-parent">
							<div class="star-fill" style="width: ${review.reviewStarPoint}%;">
								<span>★</span><span>★</span><span>★</span><span>★</span><span>★</span>
							</div>
							<div class="star-base">
								<span>★</span><span>★</span><span>★</span><span>★</span><span>★</span><span style="font-size:10px">${review.createDt}</span>
							</div>
						</div>
					</div>
					<p style="color:gray">${review.productNm} ${review.options}</p>
				</div>
				<div class="d-flex" style="height:100px; margin-bottom:10px">
					<!-- 나중에 th:each로 이미지 가져오자. 지금은 없으니 sample image로 대체 -->
					<img style="width: 100px; height: 100%" th:src="@{/images/mainImages.png}">
				</div>
				<p style="font-weight: bold; margin-bottom:0px;">${review.reviewTitle}</p>
				<p>${review.reviewContent}</p>
				<hr></hr>
				`
				reviewBody.innerHTML += rElement;
			})
		})
		document.querySelector(".header").scrollIntoView({behavior: "smooth", block: "end", inline: "nearest"});
	}
	
	//문의하기 팝업창 열기
	function openModal(){
		//show 클래스 toggle(여기서는 modal 클래스에 show가 없으니 추가됨)
		modal.classList.toggle('show');
	}
	
	//문의하기 팝업창 닫기
	function closeModal(){
		modal.classList.toggle('show');
	}
	
	//문의하기 팝업창 이외에 다른 화면 클릭 시 닫기
    modal.addEventListener('click', (event) => {
     if (event.target === modal) {
       modal.classList.toggle('show')  
     }
    });
	
	function insertInquiry(){
		console.log("진짜 대박이다");
		document.querySelector(".inquiry-form").submit();
	}
</script>
</html>