<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.daitso.customercoupon.repository.ICustomerCouponRepository">
	<!-- 
		기능: 사용가능한쿠폰 조회
		담당자: 윤상영
	-->
	<select id="selectUsableCoupon" resultType="com.example.daitso.customercoupon.model.SelectCustomerCoupon">
	SELECT *
	  FROM (
                SELECT ROW_NUMBER() OVER(ORDER by cusc.create_dt DESC) AS row_num,
                	   c.coupon_nm 									   AS "couponNm",
					   c.coupon_dscnt_rate 				  	   	   	   AS "couponDscntRate", 
					   c.coupon_epr_dt 							       AS "couponEprDt",
               	   	   cc.common_code_nm							   AS "couponUseDv"
		 		  FROM	 coupon c, customer_coupon cusc, common_code cc
				 WHERE customer_id=#{customerId}
          		   AND c.coupon_id = cusc.coupon_id 
          		   AND cusc.coupon_use_dv = cc.common_code_id
		 		   AND cusc.coupon_use_dv=203
          		   AND cusc.status='Y'
          )
          WHERE row_num between #{start} and #{end} 
	</select>
	<!-- 
		기능: 사용가능한쿠폰 갯수 카운트
		담당자: 윤상영
	-->
	<select id="countUsableCustomerCoupon" resultType="int" parameterType="int">
		SELECT count(*) 
		  FROM customer_coupon 
       	 WHERE customer_id=#{customerId}
		   AND coupon_use_dv = 203
	</select>
	
	<!-- 
		기능: 사용불가한 쿠폰 갯수 카운트
		담당자: 윤상영
	-->
	<select id="countCantUseCustomerCoupon" resultType="int" parameterType="int">
		   SELECT count(*) 
		  	 FROM customer_coupon 
       	 	WHERE customer_id=#{customerId}
		  AND NOT coupon_use_dv = 203
	</select>
	
	<!-- 
		기능: 사용불가한 쿠폰 조회
		담당자: 윤상영
	-->
	<select id="selectBanCoupon" resultType="com.example.daitso.customercoupon.model.SelectCustomerCoupon">
	       	SELECT *
			 FROM (
	                SELECT ROW_NUMBER() OVER(ORDER by cusc.create_dt DESC) AS row_num,
	                	   c.coupon_nm 									   AS "couponNm",
						   c.coupon_dscnt_rate 					  	   	   AS "couponDscntRate", 
						   c.coupon_epr_dt 							       AS "couponEprDt",
	               	   	   cc.common_code_nm							   AS "couponUseDv",
               	   	   	   cusc.coupon_use_dt							   AS "couponUseDt"
			 		  FROM coupon c, customer_coupon cusc, common_code cc
					 WHERE customer_id=#{customerId}
	          		   AND c.coupon_id = cusc.coupon_id 
	          		   AND cusc.coupon_use_dv = cc.common_code_id
			 		   AND NOT cusc.coupon_use_dv=203
	          		   AND cusc.status='Y'
	               )
          WHERE row_num between #{start} and #{end} 
	</select>
	<!-- 
		기능: 쿠폰번호입력
		담당자: 윤상영
	-->
	<insert id="insertCustomerCoupon" parameterType="String">
		INSERT INTO customer_coupon(customer_coupon_id,customer_id,coupon_id,coupon_use_dv)
		values(customer_coupon_seq.nextval,cast(#{customerId} as number(8)),
		(select distinct c.coupon_id
		from coupon c
		where c.coupon_sn = #{allCouponNum}),
		203)
	</insert>
	<!-- 
		기능: 쿠폰번호 중복입력 방지 - 입력된 번호와 같은번호 카운트 
		담당자: 윤상영
	-->
	<select id="countExistCouponSn" resultType="int" parameterType="String"> 
		SELECT count(*) 
		  FROM customer_coupon
		 WHERE customer_id= cast(#{customerId} as number(8)) 
		   AND coupon_id = (select coupon_id from coupon where coupon_sn=#{allCouponNum})
	</select>
	<!-- 
		기능: 존재하는 쿠폰의 쿠폰ID 카운트 
		담당자: 윤상영
	-->
	<select id="countExistCouponId" resultType="int" parameterType="string">
		SELECT count(*) 
		  FROM coupon 
		 WHERE coupon_sn = #{allCouponNum}
	</select>
	
	
	<!-- 
		기능: 쿠폰 유효기간 지났는지 확인 -> 지나면 만료로 바꾸기
		담당자: 최준원 
	-->
	<update id="checkCouponEprDt">
		<![CDATA[
			UPDATE customer_coupon
		   	   SET coupon_use_dv = 201
		 	 WHERE customer_coupon_id 
		 	 	IN (
					  SELECT cc.customer_coupon_id
						FROM customer_coupon cc,
							 coupon c
					   WHERE cc.coupon_id = c.coupon_id
						 AND cc.coupon_use_dv = 203
			  			 AND c.coupon_epr_dt  - TO_DATE(TO_CHAR(SYSDATE,'YYYY/MM/DD'),'YYYY/MM/DD') < 0
					)
		]]>
	</update>
	
	<!-- 
		기능: 적용가능한 쿠폰 조회
		담당자: 최준원
	-->
	<select id="getCouponsByCustomerId" parameterType="int" resultType="com.example.daitso.cart.model.CartCouponApply">
		SELECT cc.customer_coupon_id AS "customerCouponId",
		       c.coupon_id AS "couponId",
		       c.coupon_nm AS "couponNm",
		       c.coupon_dscnt_rate AS "couponDscntRate"
		  FROM coupon c,
     		   customer_coupon cc
		 WHERE cc.coupon_id = c.coupon_id	
		   AND cc.coupon_use_dv = 203
		   AND cc.customer_id = #{customerId}
		   AND c.category_id IN 
		   (
						SELECT category_id 
						  FROM category 
			        START WITH category_id = #{categoryId} 
	          CONNECT BY PRIOR category_pr_id = category_id   
		    )	
	</select>
	
	<!-- 
		기능: 구매 성공시 사용했던 쿠폰 coupon_use_dv 상태바꾸기
		담당자: 최준원 
	-->
	<update id="updateCustomerCouponStatusPurchaseSuccess">
		UPDATE customer_coupon 
   		   SET coupon_use_dv = 202,
   		   	   coupon_use_dt = SYSDATE,
       		   modifier = #{customerId},
               modify_dt = SYSTIMESTAMP
         WHERE customer_coupon_id = #{customerCouponId}
	</update>  
	
	
</mapper>